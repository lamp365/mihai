<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no">
    <title>积分兑换</title>
    <link rel="shortcut icon" href="favicon.ico"/>
    <link type="text/css" href="__RESOURCE__/recouse/bootstrap3/css/bootstrap.min.css" rel="stylesheet" />
    <link href="__RESOURCE__/recouse/css/bjcommon.css" rel="stylesheet" type="text/css" />
    <link href="__RESOURCE__/recouse/css/bjdetail.css" rel="stylesheet" type="text/css" />
    <link href="__RESOURCE__/recouse/css/iclub.css" rel="stylesheet" type="text/css" />
    <link href="__RESOURCE__/recouse/css/animate.min.css" rel="stylesheet" type="text/css" />
    <link type="text/css" rel="stylesheet" href="<?php echo RESOURCE_ROOT;?>addons/common/beAlert/css/BeAlert.css" />
    <script type="text/javascript"  src="__RESOURCE__/recouse/js/jquery-1.10.2.min.js"></script>
    <script type="text/javascript" src="<?php echo RESOURCE_ROOT;?>addons/common/beAlert/js/beAlert.js"></script>
    <script type="text/javascript" src="__RESOURCE__/recouse/bootstrap3/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="__RESOURCE__/recouse/js/cascade.js?x=14"></script>
</head>

<body>
    <!--@php  include page('vip_header');@-->
    <div style="background:url(__RESOURCE__/recouse/images/iclub_list_bg.jpg) no-repeat center;width:100%;height:925px;">
        <div style="width: 1000px;margin:0 auto;padding-top: 30px;">
            <ul class="iclub-2-list clearfix">
                <!--@php if(!empty($goods_list)){  foreach($goods_list as $one_list){ @-->
                <li>
                    <img src="<!--@php echo download_pic($one_list['logo'],300,300,2); @-->">
                    <div class="iclub-2-list-info">
                        <div class="title"><!--@php echo $one_list['title']; @--></div>
                        <div class="detail"><!--@php echo $one_list['names']; @--></div>
                        <div class="iclub-2-list-info-left">
                            <div class="mihaibi"><span><!--@php echo $one_list['jifen_change']; @--></span>个积分</div>
                            <div class="cost-price">￥<!--@php echo number_format($one_list['price'],2); @--></div>
                        </div>
                        <!--@php if($one_list['endtime'] <= time()){ @-->
                        <div class="iclub-2-list-info-right">
                            <div><a href="javascript:;" data-type="<!--@php echo $one_list['award_type']; @-->" onclick="exchangeFun(this,<!--@php  echo $one_list['id'];@-->,<!--@php echo $one_list['jifen_change']; @-->)" data-id="<!--@php  echo $one_list['id'];@-->">立即兑换</a></div>                                                                                          
                        </div>
                        <!--@php }else{ @-->
                        <div style="background:#d7d7d7" class="iclub-2-list-info-right">
                            <div><a href="javascript:;" style="cursor:context-menu"  data-type="<!--@php echo $one_list['award_type']; @-->" >立即兑换</a></div>
                        </div>
                        <!--@php } @-->
                    </div>
                </li>
                <!--@php } @-->
                <!--@php }else{ @-->
                <div style="text-align:center;margin:50px 0">
                    <img src="__RESOURCE__/recouse/images/no_record_bg.png">
                    <div>暂无可兑换的礼品</div>
                </div>
                <!--@php } @-->
            </ul>
        </div>
        <!--@php echo $pager; @-->

            <div class="modal fade choose-address-modal" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">选择地址</h4>
          </div>
          <div class="modal-body">
            <ul class="choose-address-modal-list">
                <!--@php if(empty($userAddress)){  @-->
                <div class="no-address">
                您暂无地址，请先添加地址
                </div>
                <!--@php }else{ @-->
                <!--@php foreach($userAddress as $address){ @-->
                <li>
                    <div id="<!--@php echo $address['id'];@-->" class="choose-address-div" onclick="chooseAddress(this)"><img src="__RESOURCE__/recouse/images/have_check.png"></div>
                    <div class="clearfix">
                        <div class="address-name"><!--@php echo $address['realname'];@--></div>
                        <div class="address-phone-num"><!--@php echo $address['mobile'];@--></div>
                    </div>
                    <div class="address-detail">
                        <!--@php echo $address['province'].$address['city'].$address['area'].$address['address']; @-->
                    </div>
                </li>
                <!--@php } @-->
                <!--@php } @-->
            </ul>
            <div class="add-address img-rounded" id="addAddressPanel"  style="display:none;" >
                <div class="add-address-hd">请仔细填写收货地址：</div>
                <div class="add-address-main clearfix">
                    <div class="form-group">
                        <label for="" class="col-sm-3 control-label">收货人：</label>
                        <div class="col-sm-11">
                            <input type="text" class="form-control" id="realname">
                        </div>

                        <label for="" class="col-sm-3 control-label">联系电话：</label>
                        <div class="col-sm-11">
                            <input type="text" class="form-control" id="mobile">
                        </div>

                        <label for="" class="col-sm-3 control-label">地区：</label>
                        <div class="col-sm-11">
                            <select id="sel-provance" onChange="selectCity();" class="pull-left form-control" style="width:30%; margin-right:5%;padding-left: 5px;">
                                <option value="" selected="true">省/直辖市</option>
                            </select>
                            <select id="sel-city" onChange="selectcounty()" class="pull-left form-control" style="width:30%; margin-right:5%;padding-left: 5px;">
                                <option value="" selected="true">请选择</option>
                            </select>
                            <select id="sel-area" class="pull-left form-control" style="width:30%;">
                                <option value="" selected="true">请选择</option>
                            </select>
                        </div>

                        <label for="" class="col-sm-3 control-label">详细地址：</label>
                        <div class="col-sm-11">
                            <input type="text" class="form-control" id="address">
                        </div>
                    </div>
                    <input type="hidden" id="addressid" value="" />
                    
                </div>
            </div>
          </div>
          <div class="modal-footer">
             <div class="new-btns form-group clearfix">
                <div class="col-sm-11">
                    <button type="button" class="btn btn-danger remote_url" onclick="saveAddress()" data-url="<!--@php  echo mobile_url('address',array('no_identy'=>1))@-->">保存</button>
                    <button type="button" class="btn close-btn" onclick="closeAddAddress()" >取消</button>
                </div>
            </div>
            <div class="add-btns clearfix">
                <div class="btn btn-danger" onclick="newAddAddress()">新增地址</div>
                <!--@php  if(empty($userAddress)){ @-->
                <div class="btn btn-primary disabled-sure" disabled>确认兑换</div>
                <!--@php }else{ @-->
                <div class="btn btn-primary sure">确认兑换</div>
                <!--@php } @-->
            </div>
          </div>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
    </div>
    <input type="hidden" class="productid-hidden" value="">
    <input type="hidden" class="mihaibi-hidden" value="">
    <!--@php include themePage('footer');@-->
</body>
<script>
var openid = "<?php echo checkIsLogin();?>";
$(function(){
    //确认兑换
    $(".sure").on("click",function(){
    var address_id = "";
        if( $(".isChoose").length==0 ){
            alert("请选择地址");
            return false;
        }else{
            address_id = $(".isChoose").attr("id");
        }
        var ajax_url ="<!--@php echo mobile_url('iclub',array('op'=>'change'));@-->";
        $.post(ajax_url,{id:$(".productid-hidden").val(),address_id:address_id},function(data){
            if( data.errno == 200 ){
                var first_mihaibi = parseInt($(".first-mihaibi").text())-parseInt($(".mihaibi-hidden").val());
                $(".first-mihaibi").text(first_mihaibi);
                $(".mihaibi-number").text(first_mihaibi);
                $(".choose-address-modal").modal('hide');
                alert(data.message.tit, data.message.des, '', {type: 'success'});
            }else{
                $(".choose-address-modal").modal('hide');
                alert(data.message);
            }
        },"json");
    });
})
function exchangeFun(thisObj,productid,mihaibi){
    if(openid){
        var data_type = $(thisObj).attr("data-type");
        var ajax_url ="<!--@php echo mobile_url('iclub',array('op'=>'change'));@-->";
        if ( data_type == "2" ){
            confirm('确认兑换优惠券？','',function(isconfirm){
                if( isconfirm ){
                    $.post(ajax_url,{id:productid,address_id:''},function(data){
                        if( data.errno == 200 ){
                            alert(data.message.tit);
                        }else{
                            alert(data.message);
                        }
                    },'json');
                }
            },{confirmButtonText: '确认', cancelButtonText: '取消', width: 330});
        }else{
            $(".choose-address-modal-list").show();
            $(".add-btns").show();
            $('.new-btns').hide();
            $(".choose-address-modal").modal();
            $(".productid-hidden").val(productid);
            $(".mihaibi-hidden").val(mihaibi);  
        }
    }else{
        confirm('请先登录','',function(isconfirm){
            if(isconfirm){
                var url = "<!--@php echo mobile_url('login');@-->";
                window.location.href = url;
            }
        },{confirmButtonText: '确认', cancelButtonText: '取消', width: 330});
    }
}
function addAddress() {
    $('#addAddressPanel').show();
    $('#realname').val('');
    $('#mobile').val('');
    $('#address').val('');
    $('#idname').val('');
    $('#idnumber').val('');
    cascdeInit('__RESOURCE__/recouse/js','','','');
    $('#addressid').val('');

}
function newAddAddress(){
    $(".choose-address-modal-list").hide();
    $("#addAddressPanel").show();
    $(".add-btns").hide();
    $(".new-btns").show();
}
function chooseAddress(thisObj){
    $(thisObj).parent("li").siblings().find(".choose-address-div").removeClass("isChoose");
    $(thisObj).parent("li").siblings().find("img").hide();
    if( $(thisObj).hasClass("isChoose") ){
        $(thisObj).removeClass("isChoose");
        $(thisObj).find("img").hide();
    }else{
        $(thisObj).addClass("isChoose");
        $(thisObj).find("img").show();
    }
}
function closeAddAddress(){
    addAddress();
    $('#addAddressPanel').hide();
    $('#addressid').val('');
    $(".choose-address-modal-list").show();
    $(".new-btns").hide();
    $(".add-btns").show();
}
cascdeInit('__RESOURCE__/recouse/js', '', '', '');

function saveAddress() {
    var realname = $('#realname').val();
    var mobile = $('#mobile').val();
    var province = $('#sel-provance').val();
    var city = $('#sel-city').val();
/*    var idname = $('#idname').val();
    var idnumber = $('#idnumber').val();*/
    var area = $('#sel-area').val();
    var idname ='xxxx';
    var idnumber = '35032119860618323X';
    if(area == null) {
        area = '';
    }
    if(city == null) {
        city = '';
    }
    if(province == null) {
        province = '';
    }
    var address = $('#address').val();
    if(!idname) {
        alert('请输入您的身份证姓名！');
        return false;
    }
    if(!idnumber) {
        alert('请输入您的身份证号码！');
        return false;
    }
    if(!realname) {
        alert('请输入您的真实姓名！');
        return false;
    }
    if(!mobile) {
        alert('请输入您的手机号码！');
        return false;
    }
    if(mobile.search(/^([0-9]{11})?$/) == -1) {
        alert('请输入正确的手机号码！');
        return false;
    }
    if(!address) {
        alert('请输入您的详细地址！');
        return false;
    }
    $.post("<!--@php  echo mobile_url('address',array('no_identy'=>1))@-->", {
            'op': 'post',
            'realname': realname,
            'mobile': mobile,
            'province': province,
            'city': city,
            'idnumber': idnumber,
            'idname': idname,
            'area': area,
            'address': address,
            'id': $('#addressid').val()
        },
        function(s) {
            if(s.errno == 200) {
                var html = "<li>"+
                                "<div id ="+s.message+" class='choose-address-div' onclick='chooseAddress(this)'>"+
                                "<img src='__RESOURCE__/recouse/images/have_check.png'></div>"+
                                "<div class='clearfix'>"+
                                    "<div class='address-name'>"+realname+"</div>"+
                                    "<div class='address-phone-num'>"+mobile+"</div>"+
                                "</div>"+
                                "<div class='address-detail'>"+
                                    ""+province+"  "+city+" "+area+" "+address+" "+
                                "</div>"+
                        "</li>";
                $(".no-address").hide();
                $(".disabled-sure").removeAttr("disabled");
                $(".disabled-sure").on("click",function(){
                    var address_id = "";
                    if( $(".isChoose").length==0 ){
                        alert("请选择地址");
                        return false;
                    }else{
                        address_id = $(".isChoose").attr("id");
                    }
                    var ajax_url ="<!--@php echo mobile_url('iclub',array('op'=>'change'));@-->";
                    $.post(ajax_url,{id:$(".productid-hidden").val(),address_id:address_id},function(data){
                        if( data.errno == 200 ){
                            var first_mihaibi = parseInt($(".first-mihaibi").text())-parseInt($(".mihaibi-hidden").val());
                            $(".first-mihaibi").text(first_mihaibi);
                            $(".mihaibi-number").text(first_mihaibi);
                            $(".choose-address-modal").modal('hide');
                            alert(data.message.tit, data.message.des, '', {type: 'success'});
                        }
                    },"json");
                });
                $(".choose-address-modal-list").append(html).show();
                $(".new-btns").hide();
                $(".add-btns").show();
                $('#addAddressPanel').hide();
                $('#addressid').val('')
                cascdeInit('__RESOURCE__/recouse/js','','','');
            } else {
                alert(s.message);
            }

        }, 'json');

}
</script>
</html>
