<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<title>购物车</title>
	<meta charset="utf-8">
 <meta name="viewport" content="initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no">
	<link rel="shortcut icon" href="favicon.ico"/>
	<script type="text/javascript"	src="__RESOURCE__/recouse/js/jquery-1.10.2.min.js"></script>
	<script type="text/javascript" src="__RESOURCE__/script/jquery-1.7.2.min.js"></script>
	<script type="text/javascript" src="__RESOURCE__/script/common.js"></script>
	
	<script type="text/javascript" src="__RESOURCE__/mobile/script/bootstrap.min.js"></script>
	<script type="text/javascript" src="__RESOURCE__/script/angular.min.js"></script>
	<link type="text/css" rel="stylesheet" href="__RESOURCE__/recouse/css/font-awesome.min.css" />
	<link type="text/css" rel="stylesheet" href="__RESOURCE__/mobile/style/common.mobile.css">
	<link href="__RESOURCE__/recouse/css/bjcommon.css" rel="stylesheet" type="text/css" />
	<script type="text/javascript" src="__RESOURCE__/script/cascade.js"></script>
	<script type="text/javascript" src="__RESOURCE__/mobile/script/jquery.touchwipe.js"></script>
	<script type="text/javascript" src="__RESOURCE__/mobile/script/swipe.js"></script>
</head>

<body style="padding-top:0px; ">
 <!--@php  include page('header');@-->
 <div class="c-progress">
 <div class="r cart-progress">
	<ul>
		<li class="finish finish-01"><i>1</i><span>我的购物车</span><b></b></li>
		<li><i>2</i><span>确认订单</span><b></b></li>
		<li><i>3</i><span>付款</span><b></b></li>
		<li><i>4</i><span>支付成功</span><b></b></li>
	</ul>
</div>
</div>
<div class="main" style="margin-top: 15px;">
<script type="text/javascript" src="__RESOURCE__/mobile/images/jquery.gcjs.js"></script>
<link type="text/css" rel="stylesheet" href="__RESOURCE__/mobile/style/style.css">
<style>
	.shopcart-footer{margin-bottom:49px;}
	.topTabbox{display:none}
	#mallHead{display:none}
	.nav{background:none}
	.btn{display: inline-block;}
	.btn{*display: inline;}
	.form-control{display: inline-block;+margin:0 -5px ;}
	.form-control{*display: inline;}
	.btn-default{+width: 30px;+height: 30px;}
	.input-group-btn{+width: 27px;}
	.icon-remove{+width: 11px;}
  .col-label{
    width: 23px;
    height: 23px;
    margin-top: 10px;
    margin-left: 10px;
    line-height: 20px;
  }
    .col-label img{
      width: 23px!important;
      height: 23px!important;
      border:none!important;
    }

  .shopcart-item .col-label{
    margin-top: 20px;
  }
</style>

<div class="shopcart-main">
<div style="text-align:center;padding:70px 0 70px 0; <!--@php  if(!empty($cartlist['goodslist'])) { @-->display:none<!--@php  } @-->" id='cartempty'>
    <img src="__RESOURCE__/mobile/images/icon_cart_empty.png" /><br/><br/>
    <span style='color:#adadad'>您的购物车空空如也，赶紧去
    	<a href="index.php">选购</a>
    	吧~~</span>
</div>
<!--@php if (!empty($cartlist['goodslist'])){ @-->
<div class="shopcart-all">
        <div class="list-head clearfix">
            <label class="col col-label checked"><img src="__RESOURCE__/recouse/images/cart_check.png"></label>
            <div class="col col-img">图片</div>
            <div class="col col-name">商品名称</div>
            <div class="col col-price">单价</div>
            <div class="col col-num">数量</div>
            <div class="col col-total">小计</div>
            <div class="col col-action">操作</div>
        </div>

    <form action="<!--@php  echo mobile_url('mycart',array('op'=>'choose_cart'));@-->" method="post" name="cartform">
	<!--@php foreach($cartlist['goodslist'] as $goods) {@-->
        <div class="shopcart-item" id="item_<!--@php  echo $goods['cart_id'];@-->">

            <!--@php if($goods['to_pay']){  @-->
            <label class="col col-label choose_all checked"><img src="__RESOURCE__/recouse/images/cart_check.png"></label>
            <input type="checkbox" class="hide_checkbox" checked name="cart_ids[]" value="<!--@php  echo $goods['cart_id'];@-->" style="display: none">
            <!--@php }else{ @-->
            <label class="col col-label choose_all"><img src="__RESOURCE__/recouse/images/cart_circle.png"></label>
            <input type="checkbox" class="hide_checkbox"  name="cart_ids[]" value="<!--@php  echo $goods['cart_id'];@-->" style="display: none">
            <!--@php } @-->

            <div class="col col-img">
                <a href="<!--@php  echo mobile_url('detail', array('id' => $goods['id'],'op'=>'dish'))@-->" target="_blank">
                    <img data-original="<!--@php  echo download_pic($goods['thumb'],150,150,2);@-->" class="lazy" src="/images/loading.gif">
                </a>
            </div>
            <div class="col col-name">
                <div class="name" style="text-align: center;">
                    <a href="<!--@php  echo mobile_url('detail', array('id' => $goods['id'],'op'=>'dish'))@-->" target="_blank">
                        <!--@php  echo $goods['title'];@-->
                    </a>

                </div>
            </div>
		    <div class="col col-price"> <span class="price" ><!--@php  echo $goods['marketprice'];@--> 元</span></div>

            <div class="col col-num cart_num_set">
                <div class="input-group"style="width: 93px;height: 23px;margin: 0 auto;border: solid 1px gainsboro;">
                    <span class="input-group-btn">
                        <button class="btn btn-default btn-sm" type="button" onclick="reduceNum(this,<!--@php  echo $goods['cart_id'];@-->)" style="height: 23px;width: 23px;border: none;">－</button>
                    </span>
                    <input type="tel" class="form-control input-sm pricetotal goodsnum" style="border: none;width: 48px;height:22px;line-height: 20px;margin: 0px -5px;margin-top: -3px;" value="<!--@php  echo $goods['buy_num'];@-->" price="<!--@php  echo $goods['marketprice'];@-->"   cartid="<!--@php  echo $goods['cart_id'];@-->"  maxbuy="<!--@php  echo $goods['total'];@-->" />
                    <span class="input-group-btn">
                        <button class="btn btn-default btn-sm" type="button" onclick="addNum(this,<!--@php  echo $goods['cart_id'];@-->,<!--@php  echo $goods['total'];@-->)" style="border: none;height: 23px;width: 23px;">＋</button>
                    </span>
                </div>
            </div>
		    <div class="col col-total"><span class='singletotalprice'><!--@php  echo round($goods['marketprice']*$goods['buy_num'],2);@--></span> 元</div>
            <div class="col col-action">
                <a href="javascript:;" onclick="removeCart(<!--@php  echo $goods['cart_id'];@-->)" class="shopcart-item-remove" style="width: 43px\9;">
                    <i class="icon-remove"></i>
                     删除
                </a>
            </div>
	    </div>
                   
          <!--@php  $n++;@-->
    <!--@php  } @-->
</form>

</div>

<div id='cartfooter' class="shopcart-footer" <!--@php  if(empty($cartlist['goodslist'])) { @-->style='display:none'<!--@php  } else { @--> style='margin-bottom: 49px;'  <!--@php  } @-->'>
	<span class="pull-left">
		合计(不含运费和税率)：
		<span id="pricetotal">			
		<!--@php  echo number_format($cartlist['totalprice'],2,'.','');@-->
		</span> 元
	</span>
	<a href="javascript:;" class="btn btn-success pull-right" style="background: #E0312E;color: white;padding: 0px 10px;font-size: 16px;border-radius: 5px;" id="liji_jiesuan">立即结算</a>
	<a href="javascript:void(0)" onclick="clearCart()" class="bn pull-right" style="font-size:16px; margin-right:20px"><i class="icon-trash"></i> 全部清空</a>
</div>
<!--@php } @-->
</div>
</div>

<!--@php if ( is_array($jp_goods) && !empty($jp_goods)){ @-->
      <div class="main">
        <div class="viewport" style="margin-top:10px;">
             <h4 class="newRecomTitle">大家都在买<b>全网最热门的商品推荐</b></h4>
             <div id="pro_relPur" class="goodslst clearfix">
			     <!--@php foreach ( $jp_goods as $jp_value ){ @-->
                    <div class="newRecomItemWrap ">						
					   <a  href="<!--@php  echo mobile_url('detail', array('id' => $jp_value['id'],'op'=>'dish'))@-->" target="_blank" class="itemImg">	
					       <img border="0" style="opacity: 1;" data-original="<!--@php echo $jp_value['small']; @-->" class="lazy" src="/images/loading.gif" alt="<!--@php echo $jp_value['title']; @-->" title="<!--@php echo $jp_value['title']; @-->">
					   </a>						
					   <p class="itemTitle">							
					       <a target="_blank" title="<!--@php echo $jp_value['title']; @-->"  href="<!--@php  echo mobile_url('detail', array('id' => $jp_value['id'],'op'=>'dish'))@-->"><!--@php echo $jp_value['title']; @--></a>			
					   </p>												
					   <div class="itemInfo clearfix">							
					        <p class="price">¥<!--@php echo $jp_value['marketprice']; @--><span class="marprice">¥<del><!--@php echo $jp_value['price']; @--></del></span></p>			
					   </div>		
					 </div>
					 <!--@php } @-->
			 </div>
		</div>
	</div>
		<!--@php } @-->




<!--@php include themePage('footer');@-->
<script type="text/javascript">
$(function(){
        set_parent_ischeck();

        $(".goodsnum").blur(function(){
            var id     = $(this).attr("cartid");
            var buy_num    = parseInt($(this).val());
            if(buy_num < 0 || isNaN(buy_num)) buy_num = 1;
            var maxbuy     = parseInt( $(this).attr("maxbuy") );
            if(buy_num  > maxbuy){
                alert("最多只能购买 " + maxbuy + " 件!",true);
                updateCart(this,id,maxbuy);
            }else{
                updateCart(this,id,buy_num);
            }
            
        });
        //勾选的选中与非选中
        $(".list-head .col-label").on("click",function(){
          var _this = $(this);
          //全部取消选中
          if( _this.hasClass("checked") ){
            _this.removeClass("checked");
            _this.find("img").attr("src","__RESOURCE__/recouse/images/cart_circle.png");
            $(".shopcart-item .col-label").removeClass("checked");
            $(".shopcart-item .col-label img").attr("src","__RESOURCE__/recouse/images/cart_circle.png");
            $(".shopcart-item .hide_checkbox").prop("checked",false);
            $("#pricetotal").text(0);
            $(".to_gowuche .carnum").text(0);
          }else{
            _this.addClass("checked");
              _this.find("img").attr("src","__RESOURCE__/recouse/images/cart_check.png");
            $(".shopcart-item .col-label").addClass("checked");
            $(".shopcart-item .col-label img").attr("src","__RESOURCE__/recouse/images/cart_check.png");
            $(".shopcart-item .hide_checkbox").prop("checked",true);
            canculate();
            updateCartNum();
          }
        });

        //勾选单个商品
        $(".shopcart-item .col-label").on("click",function(){
          var _this = $(this);
          if( _this.hasClass("checked") ){
              _this.removeClass("checked");
              _this.find("img").attr("src","__RESOURCE__/recouse/images/cart_circle.png");
              _this.next().prop('checked',false);
          }else{
              _this.addClass("checked");
              _this.find("img").attr("src","__RESOURCE__/recouse/images/cart_check.png");
              _this.next().prop('checked',true);
              //父类选上
              $(".list-head .col-label").find("img").attr("src","__RESOURCE__/recouse/images/cart_check.png");
              $(".list-head .col-label").addClass("checked");
          };
            canculate();
            updateCartNum();
            set_parent_ischeck();
        });
});

function set_parent_ischeck(){
    var catr_leng = $(".shopcart-item").length;
    var checknum  = 0;
    $(".shopcart-item .col-label").each(function(){
        if($(this).hasClass('checked')){
            checknum ++;
        }
    });
    if(catr_leng == 0 || checknum == 0){
        $(".list-head .col-label").removeClass("checked");
        $(".list-head .col-label").find("img").attr("src","__RESOURCE__/recouse/images/cart_circle.png");
    }else{
        $(".list-head .col-label").addClass("checked");
        $(".list-head .col-label").find("img").attr("src","__RESOURCE__/recouse/images/cart_check.png");
    }
}

function clearCart(){
    confirm('确定要清空购物车吗','',function(isSure){
        if(isSure){
            tip("正在处理数据...");
            $.getJSON("<!--@php  echo mobile_url('mycart',array('op'=>'clear'));@-->", function(data){
                tip_close();
                if(data.errno == 1){
                    $("#cartempty").show();
                    $("#cartfooter").hide();
                    //更新总价
                    canculate();
                    //更新购物车数量
                    updateCartNum();
                }else{
                    alert(data.messsage);
                }
            },'json');
        }
    });
}
function removeCart(id){
    confirm('您确定要删除此商品吗','',function(isSure){
        if(isSure){
            tip("正在处理数据...");
            var url  = "<!--@php  echo mobile_url('mycart', array('op'=>'del'))@-->";
            $.post(url, {id:id},function(data){
                tip_close();
                if(data.errno == 1){
                    $("#item_" + id).remove();
                    if($(".shopcart-item").length<=0){
                        $("#cartempty").show();
                        $("#cartfooter").hide();
                        //更新总价
                        canculate();
                        //更新购物车数量
                        updateCartNum();
                    }
                }else{
                    alert(data.message);
                }
            },'json');
        }

    });
}
function updateCart(obj,id,buy_num){
      var url  = "<!--@php  echo mobile_url('mycart', array('op'=>'updateCart'))@-->";
      $.post(url,{id:id,buy_num:buy_num},function(data){
            if(data.errno == 0){
                alert(data.message);
            }else{
                //更新数量
                $(obj).closest('.cart_num_set').find(".goodsnum").val(buy_num);
                //更新价格 小计
                var price = $(obj).closest('.cart_num_set').find(".goodsnum").attr('price');
                var one_total_prcie = parseInt(buy_num)*parseFloat(price);
                one_total_prcie = parseFloat(one_total_prcie).toFixed(2);
                $(obj).closest('.shopcart-item').find(".singletotalprice").html(one_total_prcie);
                //点亮被选中
                $(obj).closest('.shopcart-item').find('.choose_all').addClass('checked');
                $(obj).closest('.shopcart-item').find('input[name="checkbox"]').prop('checked',true);
                var picurl = "__RESOURCE__/recouse/images/cart_check.png";
                console.log(picurl);
                $(obj).closest('.shopcart-item').find('.choose_all img').attr('src',picurl);
                //更新总价
                canculate();
                //更新购物车数量
                updateCartNum();
            }
      },'json');
}

function addNum(obj,id,maxbuy){
    var buy_num = $(obj).closest('.cart_num_set').find(".goodsnum").val();
    buy_num = parseInt(buy_num)+1;
    if(buy_num>maxbuy){
        alert("库存剩下 " + maxbuy + " 件!",true);
        return;
    }
    updateCart(obj,id,buy_num);
}
function reduceNum(obj,id){
    var buy_num = $(obj).closest('.cart_num_set').find(".goodsnum").val();
    buy_num = parseInt(buy_num)-1;
    if(buy_num<=0){
        return;
    }
    updateCart(obj,id,buy_num);
}
//更新购物车右上角数字
function updateCartNum(){
    var cartNum = 0;
    $(".goodsnum").each(function(){
        if($(this).closest('.shopcart-item').find('.choose_all').hasClass("checked")){
            cartNum = cartNum + parseInt($(this).val());
        }
    });
    $(".fix_gundon .to_gowuche .carnum").html(cartNum);
}
//计算合计金额
function canculate(){
    var total = 0;    
    $(".singletotalprice").each(function(){ 
    	//先判断如果这个商品被勾选了，它的金额才计算进去
    	if($(this).closest('.shopcart-item').find('.choose_all').hasClass("checked")){
    		total+=parseFloat( $(this).html() ); 
    	}               	
    });
    total=total.toFixed(2);
    $("#pricetotal").html(total);
}
</script>
<script language='javascript'>
    function tip(msg,autoClose){
     var div = $("#poptip");
     var content =$("#poptip_content");
     if(div.length<=0){
         div = $("<div id='poptip'></div>").appendTo(document.body);
         content =$("<div id='poptip_content'>" + msg + "</div>").appendTo(document.body);
     }
     else{
         content.html(msg);
         content.show(); div.show();
     }
     if(autoClose) {
        setTimeout(function(){
            content.fadeOut(500);
            div.fadeOut(500);

        },1000);
     }
}
function tip_close(){
    $("#poptip").fadeOut(500);
     $("#poptip_content").fadeOut(500);
}

$("#liji_jiesuan").click(function(){
    var ok = false;
    $('.col-label').each(function(){
        if($(this).hasClass("checked")){
            ok = true;
        }
    })
    if(ok){
        $("form[name='cartform']").submit();
    }else{
        tip('请选择商品！',1);
    }

})
</script>
</body>
</html>