<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>积分商城</title>
    <link type="text/css" href="__RESOURCE__/recouse/bootstrap3/css/bootstrap.min.css" rel="stylesheet" />
    <link href="__RESOURCE__/recouse/css/bjcommon.css" rel="stylesheet" type="text/css" />
    <link href="__RESOURCE__/recouse/css/bjdetail.css" rel="stylesheet" type="text/css" />
    <link href="__RESOURCE__/recouse/css/iclub.css" rel="stylesheet" type="text/css" />
    <link type="text/css" rel="stylesheet" href="<?php echo RESOURCE_ROOT;?>addons/common/beAlert/css/BeAlert.css" />
    <link type="text/css" rel="stylesheet" href="<!--@php echo RESOURCE_ROOT;@-->addons/common/fontawesome3/css/font-awesome.min.css" />
    <script type="text/javascript"  src="__RESOURCE__/recouse/js/jquery-1.10.2.min.js"></script>
    <script type="text/javascript" src="__RESOURCE__/recouse/bootstrap3/js/bootstrap.min.js"></script>
</head>
<script language='javascript'>
    function tip(msg,autoClose){
     var div = $("#poptip");
     var content =$("#poptip_content");
     if(div.length<=0){
         div = $("<div id='poptip'></div>").appendTo(document.body);
         content =$("<div id='poptip_content'>" + msg + "</div>").appendTo(document.body);
     }
     else{
         content.html(msg);
         content.show(); div.show();
     }
     if(autoClose) {
        setTimeout(function(){
            content.fadeOut(500);
            div.fadeOut(500);

        },1000);
        }
    }
    function tip_close(){
    $("#poptip").fadeOut(500);
     $("#poptip_content").fadeOut(500);
    }
</script>
<body class="task-list-wrap " style="min-width: 320px;max-width: 640px;margin:0 auto;">
<!--@php if(empty($_GP['is_app'])){ @-->
    <div class="top_header">
        <div class="header_title">
            积分商城
        </div>
    </div>
<!--@php } @-->
    <!-- 轮播开始   -->  
    <div class="slider" style="<!--@php if(!empty($_GP['is_app'])){ echo 'display: none';}else{ echo 'visibility: visible'; } @-->">
        <div id="focus" class="focus">
            <div class="hd">
                <ul>
                </ul>
            </div>
            <div class="bd">
                <ul>
                    <!--@php if(empty($master_adv)){ @-->
                    <li>
                        <a href="#">
                            <img src="__RESOURCE__/recouse/images/vip_privilege_banner_01.jpg"/>
                        </a>
                    </li>
                    <li>
                        <a href="#">
                            <img src="__RESOURCE__/recouse/images/vip_privilege_banner_02.jpg"/>
                        </a>
                    </li>
                    <!--@php }else{ @-->
                    <!--@php foreach($master_adv as $one_adv){  if($one_adv['position'] !=1 ){  continue; } @-->
                    <li>
                        <a href="<!--@php echo $one_adv['link']; @-->">
                            <img src="<!--@php echo download_pic($one_adv['thumb'],800,'',1); @-->"/>
                        </a>
                    </li>
                    <!--@php } @-->
                    <!--@php } @-->
                </ul>
            </div>
        </div>
    </div>
    <!-- 轮播结束 --> 
    <div class="mihaibi-number clearfix">
        <div class="mihaibi-number-left">
        <input type="hidden" value="<!--@php echo $merInfo['credit'];@-->" class="merInfo-credit">
                <div class="lf"><img src="__RESOURCE__/recouse/images/mihaibi.png"/></div>
                <div class="rg">
                <!--@php if(empty($merInfo)){ @-->
                    <div class="mhn" style="line-height: 37px;"><a href="javascript:void(0);" onclick="login()">点此登录</a></div>
                    <!--@php }else{ @-->
                        <!--@php if(empty($_GP['is_app'])){ @-->
                        <a href="<!--@php echo mobile_url('iclub',array('op'=>'recorder'));@-->">
                            <div>可用积分</div>
                            <div class="mhn first-mihaibi"><span><!--@php echo $merInfo['credit'];@--></span></div>
                        </a>
                        <!--@php }else{ @-->
                        
                            <div>可用积分</div>
                            <div class="mhn first-mihaibi"><span><!--@php echo $merInfo['credit'];@--></span></div>
                        
                        <!--@php } @-->
                   
                    <!--@php } @-->
                </div>
        </div>
        <div class="mihaibi-number-right">

                <div class="lf"><img src="__RESOURCE__/recouse/images/mihaibi_record.png"/></div>
                <div class="rg">
                    <div style="line-height: 37px;;">
                    <!--@php if(empty($_GP['is_app'])){ @-->
                        <a href="<!--@php  echo mobile_url('miyou',array('op'=>'invite'))@-->">获取更多积分</a>  
                    <!--@php }else{ @-->
                        <a href="<!--@php echo mobile_url('iclub',array('op'=>'recorder','is_app'=>1));@-->">
                        兑换记录
                        </a>
                     <!--@php } @-->
                    </div>
                </div>

        </div>
    </div>
    <!-- 积分超值兑 -->
    <div class="exchange-area exchange-total-area">

        <div class="exchange-title clearfix">
        缤纷好礼，超值兑
        </div>
    <input type="hidden" class="productid-hidden" value="">
    <input type="hidden" class="mihaibi-hidden" value="">     
        <ul class="exchange-list clearfix">
            <!--@php if(!empty($goods_list)){  foreach($goods_list as $one_list){ @-->
            <li>
                <img src="<!--@php echo download_pic($one_list['logo'],300,300,2); @-->">
                <div class="price clearfix">
                    <div class="price-left"><!--@php echo $one_list['jifen_change']; @-->积分</div>
                    <div class="price-right"><!--@php echo $one_list['price']; @-->元</div>
                </div>
                <div class="title"><!--@php echo $one_list['title']; @--></div>
                <!--@php if($one_list['endtime'] <= time()){ @-->
                <div class="exchange-list-btn" data-type="<!--@php echo $one_list['award_type']; @-->" onclick="exchangeFun(this,<!--@php  echo $one_list['id'];@-->,<!--@php echo $one_list['jifen_change']; @-->)" >立即兑换</div>
                <!--@php }else{ @-->
                <div style="background:#d7d7d7" class="exchange-list-btn" data-type="<!--@php echo $one_list['award_type']; @-->" >立即兑换</div>
                <!--@php } @-->

            </li>
            <!--@php } @-->
            <!--@php }else{ @-->
            <p>暂无可兑换的礼品</p>
            <!--@php } @-->
        </ul>
    </div>
        <!-- 选择地址 -->
    <div class="modal fade choose-address-modal" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">选择地址</h4>
          </div>
          <div class="modal-body">
            <ul class="choose-address-modal-list">
                <!--@php if(empty($userAddress)){  @-->
                <div class="no-address">
                您暂无地址，请先添加地址
                </div>
                <!--@php }else{ @-->
                <!--@php foreach($userAddress as $address){ @-->
                <li>
                    <div id="<!--@php echo $address['id'];@-->" class="choose-address-div" onclick="chooseAddress(this)"><img src="__RESOURCE__/recouse/images/have_check.png"></div>
                    <div class="clearfix">
                        <div class="address-name"><!--@php echo $address['realname'];@--></div>
                        <div class="address-phone-num"><!--@php echo $address['mobile'];@--></div>
                    </div>
                    <div class="address-detail">
                        <!--@php echo $address['province'].$address['city'].$address['area'].$address['address']; @-->
                    </div>
                </li>
                <!--@php } @-->
                <!--@php } @-->
            </ul>
            <div class="add-address img-rounded" id="addAddressPanel"  style="display:none;" >
                <div class="add-address-hd">请仔细填写收货地址：</div>
                <div class="add-address-main">
                    <div class="form-group">
                        <label for="" class="col-sm-3 control-label">收货人：</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="realname">
                        </div>

                        <label for="" class="col-sm-3 control-label">联系电话：</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="mobile">
                        </div>

                        <label for="" class="col-sm-3 control-label">地区：</label>
                        <div class="col-sm-9">
                            <select id="sel-provance" onChange="selectCity();" class="pull-left form-control" style="width:30%; margin-right:5%;padding-left: 5px;">
                                <option value="" selected="true">省/直辖市</option>
                            </select>
                            <select id="sel-city" onChange="selectcounty()" class="pull-left form-control" style="width:30%; margin-right:5%;padding-left: 5px;">
                                <option value="" selected="true">请选择</option>
                            </select>
                            <select id="sel-area" class="pull-left form-control" style="width:30%;">
                                <option value="" selected="true">请选择</option>
                            </select>
                        </div>

                        <label for="" class="col-sm-3 control-label">详细地址：</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="address">
                        </div>
                    </div>
                    <input type="hidden" id="addressid" value="" />
                    
                </div>
            </div>
          </div>
          <div class="modal-footer">
             <div class="new-btns form-group">
                <div class="col-sm-12">
                    <button type="button" class="btn btn-danger remote_url" onclick="saveAddress()" data-url="<!--@php  echo mobile_url('address',array('no_identy'=>1))@-->">保存</button>
                    <button type="button" class="btn close-btn" onclick="closeAddAddress()" >取消</button>
                </div>
            </div>
            <div class="add-btns">
                <div class="btn btn-danger" onclick="newAddAddress()">新增地址</div>
                <!--@php  if(empty($userAddress)){ @-->
                <div class="btn btn-primary disabled-sure" disabled>确认兑换</div>
                <!--@php }else{ @-->
                <div class="btn btn-primary sure">确认兑换</div>
                <!--@php } @-->
            </div>
          </div>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
<div class="weixin_gzh"></div>
<div class="weixin_gzh_img">
    <img src="__RESOURCE__/recouse/images/weixin_gzh.png">
</div>
    <!--用来存当前page-->
<input type="hidden" value="2" id="page"/>
<div class="ajax_next_page">
    <img class="jiazai" src="__RESOURCE__/recouse/images/ajax-loader.gif"/>
    正在加载
</div>

    <!--@php if(empty($_GP['is_app'])){ @-->
    <!--@php include themePage('footer');@-->
    <!--@php } @-->
</body>

<script type="text/javascript" src="<?php echo RESOURCE_ROOT;?>addons/common/beAlert/js/beAlert.js"></script>
<script type="text/javascript" src="__RESOURCE__/recouse/js/TouchSlide.1.1.js"></script>
<script type="text/javascript" src="__RESOURCE__/recouse/js/cascade.js?x=14"></script>
<script>
var openid = "<?php echo checkIsLogin();?>";
var index = 1;
$(function(){
    //轮播初始化
    TouchSlide({
        slideCell : "#focus",
        titCell : ".hd ul", //开启自动分页 autoPage:true ，此时设置 titCell 为导航元素包裹层
        mainCell : ".bd ul",
        delayTime : 600,
        interTime : 4000,
        effect : "leftLoop",
        autoPlay : true,//自动播放
        autoPage : true, //自动分页
        switchLoad : "_src" //切换加载，真实图片路径为"_src" 
    });
    //滚动条到底部时就加载剩下数据
    $(window).scroll(function(){            
        if ($(document).scrollTop() >= $(document).height() - $(window).height()) {
            Refresh();
        }
    })
    $(".weixin_gzh,.weixin_gzh_img").on("click",function(){
        $(".weixin_gzh,.weixin_gzh_img").hide();
    });
    //后退按钮
    $(".return").click(function(){
        var refer = document.referrer;//没有来源url
        if(refer.length == 0){
            var url = "index.php";
        }else{
            var url ="<!--@php echo  mobile_url('iclub'); @-->"
        }
        window.location.href = url;
    });
    
    //确认兑换
    $(".sure").on("click",function(){
    var address_id = "";
        if( $(".isChoose").length==0 ){
            alert("请选择地址");
            return false;
        }else{
            address_id = $(".isChoose").attr("id");
        }
        var ajax_url ="<!--@php echo mobile_url('iclub',array('op'=>'change'));@-->";
        $.post(ajax_url,{id:$(".productid-hidden").val(),address_id:address_id},function(data){
            if( data.errno == 200 ){
                var first_mihaibi = parseInt($(".first-mihaibi").text())-parseInt($(".mihaibi-hidden").val());
                $(".first-mihaibi span").text(first_mihaibi);
                $(".choose-address-modal").modal('hide');
                alert(data.message.tit, data.message.des, '', {type: 'success'});
            }else{
                $(".choose-address-modal").modal('hide');
                alert(data.message);
            }
        },"json");
    });
})

function exchangeFun(thisObj,productid,mihaibi){
    if(!check_is_weixin()){
        //如果不是微信
        return false;
    }
    if(openid){
        var keyong_jifen = parseInt($(".merInfo-credit").val());
        var xuyao_jifen = parseInt($(thisObj).siblings(".price").find(".price-left").text());
        if( keyong_jifen < xuyao_jifen ){
            confirm('您的积分不足以兑换','',function(isconfirm){
                if( isconfirm ){
                   window.location.href = "<!--@php  echo mobile_url('miyou',array('op'=>'invite'))@-->";
                }
            },{confirmButtonText: '获取积分', cancelButtonText: '取消', width: 300});
            return false;
        } 
        var data_type = $(thisObj).attr("data-type");
        var ajax_url ="<!--@php echo mobile_url('iclub',array('op'=>'change'));@-->";
        if ( data_type == "2" ){
            confirm('确认兑换优惠券？','',function(isconfirm){
                if( isconfirm ){
                    $.post(ajax_url,{id:productid,address_id:''},function(data){
                        if( data.errno == 200 ){
                            var url = "<!--@php  echo mobile_url('bonus')@-->";
                            var daojishi = 0;
                            alert("<div style='font-size:14px'>兑换成功,前往“卡券包”查看 自动：跳转<span class='daojishi'>3</span>s</div>",'',function(){
                                window.location.href = url;
                            });
                            setInterval(function(){
                                daojishi = parseInt($(".daojishi").text())-1;
                                if( daojishi >= 0){
                                    $(".daojishi").text(daojishi);
                                }else{
                                    window.location.href = url;
                                }
                            },1000);
                        }else{
                            alert(data.message);
                        }
                    },'json');
                }
            },{confirmButtonText: '确认', cancelButtonText: '取消', width: 300});
        }else{
            $(".choose-address-modal-list").show();
            $(".add-btns").show();
            $('.new-btns').hide();
            $(".choose-address-modal").modal();
            $(".productid-hidden").val(productid);
            $(".mihaibi-hidden").val(mihaibi);  
        }
    }else{
        confirm('请先登录','',function(isconfirm){
            if(isconfirm){
                var url = "<!--@php echo mobile_url('login');@-->";
                window.location.href = url;
            }
        },{confirmButtonText: '确认', cancelButtonText: '取消', width: 300});
    }
}
cascdeInit('__RESOURCE__/recouse/js','','','');
function login(){
    var url = "<!--@php echo mobile_url('login');@-->";
    window.location.href = url;
}
function check_is_weixin(){
    var is_weixin = "<!--@php echo $is_weixin; @-->";
    if(is_weixin == 0){
        $(".weixin_gzh,.weixin_gzh_img").show();
        return false;
    }else{
        return true;
    }
}
function saveAddress() {
    var realname = $('#realname').val();
    var mobile = $('#mobile').val();
    var province = $('#sel-provance').val();
    var city = $('#sel-city').val();
    var area = $('#sel-area').val();
    var check_identy = $(".remote_url");
    if($(check_identy).hasClass('check_identy')){
        var idname = $("#idname").val();
        var idnumber = $("#idnumber").val();
    }else{
        var idname ='xxxx';
        var idnumber = '35032119860618323X';
    }

    var address = $('#address').val();
    if(area==null)
    {
        area='';
    }
        if(city==null)
    {
        city='';
    }
        if(province==null)
    {
        province='';
    }

    if (!realname) {
        alert('请输入您的真实姓名！');
        return false;
    }
    if (!mobile) {
        alert('请输入您的手机号码！');
        return false;
    }
    if (mobile.search(/^([0-9]{11})?$/) == -1) {
        alert('请输入正确的手机号码！');
        return false;
    }
    if (!address) {
        alert('请输入您的详细地址！');
        return false;
    }
    if(!idname){
        alert("请输入您的身份证号码！");
        return false;
    }
    if(!idnumber){
        alert("请输入您的身份证号码！");
        return false;
    }
    if(idnumber.length != 18){
        alert("请输入正确的身份证号码！");
        return;
    }
    tip("正在处理数据...");
    var url = $(".remote_url").data('url');
    $.post(url, {
        'op' : 'post',
        'realname' : realname,
        'mobile' : mobile,
        'province' : province,
        'city' : city,
        'area' : area, 
        'address' : address,
        'idname' : idname,
        'idnumber' : idnumber,
        'id' : $('#addressid').val()
    }, function(s) {
        tip_close();
        if (!isNaN(s.message) && s.message != 0) {
            var html = "<li>"+
                                "<div id ="+s.message+" class='choose-address-div' onclick='chooseAddress(this)'>"+
                                "<img src='__RESOURCE__/recouse/images/have_check.png'></div>"+
                                "<div class='clearfix'>"+
                                    "<div class='address-name'>"+realname+"</div>"+
                                    "<div class='address-phone-num'>"+mobile+"</div>"+
                                "</div>"+
                                "<div class='address-detail'>"+
                                    ""+province+"  "+city+" "+area+" "+address+" "+
                                "</div>"+
                        "</li>";
            $(".no-address").hide();
            $(".disabled-sure").removeAttr("disabled");
            $(".disabled-sure").on("click",function(){
                var address_id = $(".choose-address:checked").attr("id");
                if( !address_id){
                    alert("请选择地址");
                    return false;
                }
                var ajax_url ="<!--@php echo mobile_url('iclub',array('op'=>'change'));@-->";
                $.post(ajax_url,{id:$(".productid-hidden").val(),address_id:address_id},function(data){
                    if( data.errno == 200 ){
                        var first_mihaibi = parseInt($(".first-mihaibi").text())-parseInt($(".mihaibi-hidden").val());
                        $(".first-mihaibi span").text(first_mihaibi);
                        $(".choose-address-modal").modal('hide');
                        alert(data.message.tit, data.message.des, '', {type: 'success'});
                    }else{
                        $(".choose-address-modal").modal('hide');
                        alert(data.message);
                    }
                },"json");
            });
            $(".choose-address-modal-list").append(html).show();
            $(".new-btns").hide();
            $(".add-btns").show();
            $('#addAddressPanel').hide();
            $('#addressid').val('')
            cascdeInit('__RESOURCE__/recouse/js','','','');
        }else{
            if(s.message == 0)
                alert("新增地址失败请再试一次");
            else
                alert(s.message);

            setTimeout(function(){
                tip_close();
            },4000);
        }

    }, 'json');

}
function closeAddAddress(){
    addAddress();
    $('#addAddressPanel').hide();
    $('#addressid').val('');
    $(".choose-address-modal-list").show();
    $(".new-btns").hide();
    $(".add-btns").show();
}
function newAddAddress(){
    $(".choose-address-modal-list").hide();
    $("#addAddressPanel").show();
    $(".add-btns").hide();
    $(".new-btns").show();
}
function addAddress() {
    $('#addAddressPanel').show();
    $('#realname').val('');
    $('#mobile').val('');
    $('#address').val('');
    $('#idname').val('');
    $('#idnumber').val('');
    cascdeInit('__RESOURCE__/recouse/js','','','');
    $('#addressid').val('');

}
function chooseAddress(thisObj){
    $(thisObj).parent("li").siblings().find(".choose-address-div").removeClass("isChoose");
    $(thisObj).parent("li").siblings().find("img").hide();
    if( $(thisObj).hasClass("isChoose") ){
        $(thisObj).removeClass("isChoose");
        $(thisObj).find("img").hide();
    }else{
        $(thisObj).addClass("isChoose");
        $(thisObj).find("img").show();
    }
}

function Refresh(){
    if( index == 1){
        $(".ajax_next_page").show();
        index = 0; //关闭开关
        var page = $("#page").val(); //第一次传的是2
        $.post("", {'page' : page,'nextpage' : 'ajax','op':'list'}, function(s){
            if(s.errno != 200){
                //如果没有数据
                $(".ajax_next_page").hide();
            }else{
                $("#page").val(++page);
                var art_data = s.message;
                for(var i = 0;i < art_data.length;i++){
                    //循环拼接 html下一页数据
                    Load(art_data[i]);
                }
                index = 1;  //加载完后重新打开开关
                $(".ajax_next_page").hide();
            }
        }, 'json');

    }
}
function Load(art_data){    
    //觅海头条的append
    var now_time = new Date();
        now_time = parseInt(now_time.getTime()/1000);

    var btn_html = "";
    if( now_time < parseInt(art_data.endtime) ){
        btn_html = '<div class="exchange-list-btn" style="background:#d7d7d7">立即兑换</div>';
    }else{
        btn_html = '<div class="exchange-list-btn" data-type='+art_data.award_type+' onclick="exchangeFun(this,'+art_data.id+','+art_data.jifen_change+')">立即兑换</div>';
    }
    var li ='<li>'+
                '<img src="'+ art_data.logo +'"/>'+
                    '<div class="price clearfix">'+
                        '<div class="price-left">'+art_data.jifen_change+'积分</div>'+
                        '<div class="price-right">'+art_data.price+'元</div>'+
                    '</div>'+
                    '<div class="title">'+art_data.title+'</div>'+btn_html
            '</li>';
    $(".exchange-list").append(li);
}
</script>
</html>
