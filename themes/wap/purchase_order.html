<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no">
	<title>批发采购</title>
	<link rel="stylesheet" type="text/css" href="__RESOURCE__/recouse/css/reset.css">
	<link rel="stylesheet" type="text/css" href="__RESOURCE__/recouse/css/purchase.css">
	<link rel="stylesheet" type="text/css" href="__RESOURCE__/recouse/bootstrap3/css/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" href="__RESOURCE__/recouse/css/bjcommon.css">
	<script type="text/javascript" src="__RESOURCE__/recouse/js/jquery-1.10.2.min.js"></script>
	<script type="text/javascript" src="__RESOURCE__/recouse/js/jquery.lazyload.min.js"></script>
	<script type="text/javascript" src="__RESOURCE__/recouse/bootstrap3/js/bootstrap.min.js"></script>
</head>
<body>
<!--美元或人民币的隐藏域 -->
	<input type="hidden" name="currency" class="currency" value="<?php echo $currency; ?>">
	<div class="wrap">
		<div class="viewport">
			<div class="tab">
				<p class="select on select-p">选择商品</p>
				<p class="selected select-p">已选商品(<span><!--@php echo $max_purchase; @--></span>)</p>
				<!-- <div class="select-p">全选</div>
				<a href="javascript:void(0);"  class="click screen">筛选</a> -->
			</div>
			<div style="height: 43px;width: 100%;"></div>
			<div class="tab-div-select">
				<div class="WX_search1" id="mallHead" style="z-index:1;padding-bottom: 5px;">
					<form class="WX_search_frm1"  id="searchForm"	 method="post" name="">
						<input type="text" name="keyword" class="WX_search_txt hd_search_txt_null"
							placeholder="请输入商品名进行搜索！" value="<?php  echo $_GP['keyword'];?>" class="product-number">
						<select  name="key_type" class="key_type">
								<option value="title" <?php if($_GP['key_type']=='title'){?>selected="selected"<?php  } ?> >产品名称</option>
								<option value="id" <?php if($_GP['key_type']=='id'){?>selected="selected"<?php  } ?>>条形码</option>
						</select>
						<div class="WX_me">
							<button id="submit" class="WX_search_btn_blue">  </button> 
						</div>
					</form>
					<div class="search_bottom"></div>
				</div>
				<ul class="product-lists" id="product-list">
					<!--@php if ( is_array($dish_list) && !empty($dish_list) ){ foreach ( $dish_list as $dish_list_value ){ @-->
					<li>
						<div class="product-img">
							<img class="lazy" product_id="<!--@php echo $dish_list_value['id']; @-->" data-original="<!--@php echo $dish_list_value['thumb']; @-->" src="images/loading.gif" >
							
						</div>
						<div class="product-title">
							<div class="product-name product-img-click" onclick="productName(this)" product_id="<!--@php echo $dish_list_value['id']; @-->"><!--@php echo $dish_list_value['title']; @--></div>
							<div class='modal fade product-detail' tabindex='-1' role='dialog' aria-labelledby='myLargeModalLabel' aria-hidden='true'>  
								<div class='modal-dialog modal-lg'>
									<div class='modal-content'>
										<div class='modal-header'> 
											<button type='button' class='close' data-dismiss='modal'>
												<span aria-hidden='true'>&times;</span>
												<span class='sr-only'>Close</span>
											</button>
											<h4 class='modal-title' class='myModalLabel'><!--@php echo $dish_list_value['title']; @--></h4>
										</div>
										<div class='modal-body'>
											<div class="ajax-load"><img src="__RESOURCE__/recouse/images/ajax-loader.gif"></div>
										</div>
										<div class="modal-footer">
										    <button class="btn btn-success" type="button" data-dismiss="modal">关闭</button>
										</div>
									</div>
								</div>
							</div>
						</div>
						<div class="product-price">
							<span><i class="currency-span">$</i><!--@php echo $dish_list_value['price']; @--></span>
						</div>
						<div class="col-num" cartid="<!--@php echo $dish_list_value['id']; @-->">
							<div class='input-group'>
								<span class='input-group-btn'>
									<button class='btn btn-default btn-sm btn-reduce' type='button' onclick='reduceNum(<!--@php echo $dish_list_value['id']; @-->)'>-</button>
								</span>
								<input type='tel' value="1" class='form-control input-sm pricetotal goodsnum ' onblur="blurNum(this)"  cartid="<!--@php echo $dish_list_value['id']; @-->" id='goodsnum_<!--@php echo $dish_list_value['id']; @-->' price="<!--@php echo $dish_list_value['price']; @-->"  maxbuy="<!--@php echo $dish_list_value['total']; @-->">
								<span class='input-group-btn'>
									<button class='btn btn-default btn-sm btn-add' type='button' onclick='addNum(<!--@php echo $dish_list_value['id']; @-->,<!--@php echo $dish_list_value['total']; @-->)'>+</button>
								</span>
							</div>
						</div>
						<!--@php if ( $dish_list_value['selected'] == 0 ){ @-->
						<div class="col-action"><span onclick="colcheck(this)" class='col-check' id="<!--@php echo $dish_list_value['id']; @-->">选择</span></div>
                         <!--@php  }else{ @-->
						<div class="col-action"><span onclick="colcheck(this)" class='col-check added' id="<!--@php echo $dish_list_value['id']; @-->">已选</span></div>
						<!--@php } @-->

					</li>
					<!--@php }} @-->
				</ul>
				<!--@php echo $pager; @-->
                <div style="height:50px;width:100%;"></div>
				<!--@php include themePage('purchase_footer');@-->
			</div>
			<div class="tab-div-select" style="display: none;">
				<div class="add-list-area">
					<div class="hide-area" style="display: none;">
						<ul class="add-list">
							
						</ul>
						<div class="address-area">
							<!--@php  if(!empty($addresslist)) {  @-->
							<div id="addresslist">
							    <!--@php if ( is_array($addresslist) ){ foreach( $addresslist as $defaultAddress ){ @-->

								<div class="address_item <!--@php if (($defaultAddress['isdefault'] == 1 && count($addresslist) > 1 ) || ( count($addresslist) == 1 )) { echo 'this_address'; } @--> address_<!--@php  echo $defaultAddress['id']; @-->" onclick="setaddress(<!--@php echo $defaultAddress['id']; @-->)" address_id = '<!--@php echo $defaultAddress['id']; @-->'>
								    <div  class="dosg">
										<span class="edit" onclick="openDialog('<!--@php  echo mobile_url('purchase_address',array('op'=>'ajax','id'=>$defaultAddress['id']))@-->')"><img src="__RESOURCE__/recouse/images/edit.png">修改</span>
										<span class="del"  onclick="addressDel(<!--@php  echo $defaultAddress['id']; @-->)"><img src="__RESOURCE__/recouse/images/delete.png">删除</span>
									</div>
								    <div class="addr-bd">				
									   <strong style="float: left;"><!--@php  echo $defaultAddress['realname'];@--></strong>
									   <span class="set" onclick="setdefault(<!--@php echo $defaultAddress['id']; @-->)"><!--@php if ($defaultAddress['isdefault'] ==1 ) { echo '默认地址'; }else{ echo '设为默认'; } @--></span>
									</div>
									<div class="addr-hd">				
									<!--@php  echo $defaultAddress['province'];@--> <!--@php  echo $defaultAddress['city'];@--> <!--@php  echo $defaultAddress['area'];@--><!--@php  echo $defaultAddress['address'];@--> 
									<!--@php  echo $defaultAddress['mobile'];@-->
									</div>
									
									<div class="choose">
									</div>
								</div>	
								<!--@php }} @-->
							</div>
											
							<!--@php  }else{  @-->
			                <div id="addresslist"></div>
							<!--@php } @-->
						</div>
						<div style="width: 100%;overflow: hidden;">
								<div class="address_add">
									<button type="button" class="btn btn-danger" onclick="openDialog('<!--@php  echo mobile_url('purchase_address',array('op'=>'ajax'))@-->')"> + 添加收货地址</button>
									<button type="button" class="btn btn-danger show-more" >显示更多地址</button>
									<button type="button" class="btn btn-danger hide-more" >收起更多地址</button>
								</div>
						</div>
						<!--@php if ( $user_a['type'] == 2 ){ @-->
						<div class="freight-area">
							<h3>配送方式</h3>
							<label onclick="freightFun()"><input type="radio" name="freight" value="0" checked>觅海供应链配送</label>
							<label onclick="freightFun()"><input type="radio" name="freight" value="1">买家承运</label>
						</div>
						<!--@php } @-->
						<div class="tiaokuan">
						      <h3>条款与条件</h3>
						</div>
						<div class="total-area terms">
							<label>
								
								<div class="terms-content">
									<p style="text-indent: 2em;">通过单击 “下单”，我同意接受觅海供应链在线商店条款和条件。发货和送达日期为觅海供应链做出的最佳估算时间。就少数订单，由于无法预料的产品短缺或超出我们控制以外的因素，实际时间可能会更长。如有延迟，我们将联系您。
									我们网站上的产品和定价信息在公布前已经过核实。但是，在极少数情形下可能有误。如果我们发现定价错误，我们将通知您，取消您的订单，并对订单金额全额退款。
									您应仔细阅读条款和条件中有关争议解决的条款，您确认本订单即视为您理解争议将通过仲裁方式解决，仲裁机构及仲裁地点详见条款和条件。</p>
								</div>
								<input type="checkbox" name="" class="terms-accept" ><span>我同意以上条款</span>
							</label>
						</div>
						<div class="remark-info">
						      <h3 >备注信息</h3>
						      <ul class="member-browse-ul" style="padding:15px;">
									<li><textarea name="remark" class="remark" style="width:100%;border:none;" type="text" value="" placeholder="亲，还有什么要交待的话，告诉我们吧！"></textarea></li>
								</ul>
						</div>
						<!--@php if ( $user_a['type'] == 2 ){ @-->
						<div class="exchangeRate-area add-list-div">
							<h3>订单要求</h3>
							<!--汇率隐藏域-->
							<p style="font-size: 12px;">单个订单总额必须高于2000人民币系统才会审核通过，否则无法下单</p>
						</div>
						<div class="exchangeRate-area">
							<h3>货币汇率</h3>
							<!--汇率隐藏域-->
							<p><!--@php echo $exchange_rate_value; @--></p>
							<input type="hidden" name="exchangeRate" class="exchange_rate" value="<!--@php echo $exchange_rate_value; @-->">
						</div>
	                    <!--@php }else{ @-->
						    <!--@php if ( is_array($promotion) && !empty($promotion) ){ @-->
	                        <div class="exchangeRate-area">
							<h3>免运费条件</h3>
							     <!--@php foreach ( $promotion as $promotion_value ){ @-->
								 
						     	<p><!--@php if($promotion_value['promoteType']==0){ @-->商品件数满<span style="color:#FF0000"><!--@php echo $promotion_value['condition'];@--></span>件免运费<!--@php  }else{ @-->商品金额满<span style="color:#FF0000"><!--@php echo  $promotion_value['condition'];@--></span>元免运费 <!--@php  } @--></p>
							    <!--@php } @-->
							<!--@php } @-->
						</div> 
						<!--@php } @-->

						<div class="pay-footer">
							<div class="footer-left total-area">
								<p class="total-price-p">商品合计：<span class="total-price"></span></p>
								<p class="dispatchprice">运费：<span></span></p>
								<div style="clear: both;"></div>
								<p class="pay-total-price">订单金额：<span></span></p>
							</div>
							<div class="footer-right submit next-step">下单</div>
						</div>

					</div>
				</div>
				<div class="add-list-area-tip">
					<img class="lazy" src="__RESOURCE__/recouse/images/icon_network_error_retry.png">
					<p style="margin-top: 40px;color: #cccccc;font-size: 18px;text-align: center;">你还没有选择商品，请选择商品</p>
				</div>
				<div class="ajax_load_hide">
					<div class="loading-area"><img class="loading-img" src="__RESOURCE__/recouse/images/ajax-loader.gif"></div>
				</div>
				<div class="ajax_load">
					<div class="loading-area"><img class="loading-img" src="__RESOURCE__/recouse/images/ajax-loader.gif"></div>
				</div>
			</div>
		</div>
		<div class="filter">
	      	<div class="filter-header">
	            <a href="#" class="filter-header-left">返回</a>
	            <h3>分类</h3>
	      	</div>
		  	<div class="bodys">
	           	<ul>
	                <li class="p2">
					    <a href=""><img src="" height="29" />126313<i class="icon-ok"></i></a>
					</li>
					<li class="p2">
					    <a href=""><img src="" height="29" />126313<i class="icon-ok"></i></a>
					</li>
			   	</ul>
	      	</div>
		</div>
	</div>

	<div class='modal fade confirm-modal' tabindex='-1' role='dialog' aria-labelledby='myLargeModalLabel' aria-hidden='true'>  
		<div class='modal-dialog modal-lg'>
			<div class='modal-content'>
				<div class='modal-header'>
					<button type='button' class='close' data-dismiss='modal'>
						<span aria-hidden='true'>&times;</span><span class='sr-only'>Close</span>
					</button>
					<h4 class='modal-title' id='myModalLabel'>订单详情</h4>
				</div>
				<div class='modal-body ajax-loader loading-img'>
					<img class="loading-img" src="__RESOURCE__/recouse/images/ajax-loader.gif">
				</div>
				<div class='modal-body confirm-body'>
					<div class="orderDetail-area">
						<div class="order_title">	
							<div class="" style="overflow: hidden;">
						    	<select id="pays" class="form-control" style="float:left;width:100px!important;height:30px!important;padding-left:5px!important;border: 1px solid #ccc!important;line-height:15px;font-size:12px;) no-repeat scroll right center transparent;  background:#fff\0;  padding-right: 14px;text-align: left;">
									<option value="weixin"> 微信支付</option>
									<option value="alipay" selected=""> 支付宝</option>
								</select>
								<a href="javascript:;" onclick="topay();" class="btn btn-danger btn-sm" style="float:left;width:100px;margin-left:10px;">立即支付</a>
							</div>
							<div class="my-style">订单号：<span class="confirm-order-num"></span></div>	
							<div class="my-style">支付金额：<span class="confirm-order-price false"></span> </div>
						</div>
						<div class="orderdetail my-style">
							<p class="Address">
								<img src="__RESOURCE__/recouse/images/icon_diary_location.png" style="width: 16px;margin-top: 2px;"><span class="confirm-order-address"></span>
							</p>
						</div>
					</div>
					<ul class="confirm-table"></ul>
					<div class="confirm-area">
						<div class="confirm-modal-remark">
						</div>
						<div class="confirm-modal-price">
							<p>商品应付总计：<span class="total-price"></span></p>
							<p class="dispatchprice">运费：<span></span></p>
							<p class="pay-total-price">应付金额：<span></span></p>
						</div>
					</div>
				</div>
				<div class="modal-footer">
				    <button class="btn btn-success" type="button" data-dismiss="modal">关闭</button>
				</div>
			</div>
		</div>
	</div>
	<iframe src="" class="address"></iframe>
	<div class="iDialogLayout"></div>

	<script type="text/javascript">
		$(function(){
			$("img.lazy").lazyload({
				 threshold : 50,
				 failure_limit : 10,
				 effect : "fadeIn"
			});
			currency();
			var index = 0;
			$(".tab p").on("click",function(){
				index = $(this).index();
				$(this).siblings("p").removeClass("on");
				$(this).addClass("on");
				$(".tab-div-select").hide().eq(index).show();
			});

			
	    	addressFun();
	    	$(".show-more").on("click",function(e){
	    		addressFun();
	    		$(this).hide();
	    		$(".hide-more").show();
	    		$(".address-area .address_item:gt(0)").show();
	    		e.stopPropagation();
	    	})
	    	$(".hide-more").on("click",function(e){
	    		addressFun();
	    		$(this).hide();
	    		$(".show-more").show();
	    		$(".address-area .address_item:gt(0)").hide();
	    		e.stopPropagation();
	    	})

			$(".click").click(function(){
		         $(".filter").addClass("move"); 
				  changeDivHeight("html",0); 
				  changeDivHeight("body",0); 
				  $("body").css("overflow","hidden");
			});
			$(".filter-header-left").click(function(){
		       $(".filter.move").removeClass("move");
		       $("body").css("height","auto");
			   $("html").css("height","auto");
			});


			$(".selected").on("click",function(){
				getGoods();
				addressFun();
			});
			

		    //生成订单

			$(".next-step").on("click",function(e){
				var checkedVal = $(".terms-accept").prop("checked");
				var address_id = $(".this_address").attr("address_id");
				var remark = $(".remark").val();
				var confirm_address_html;
				var confirm_html = "";
				var dataObj = "";
				var freight = $(".freight-area input[type='radio']:checked").val();
				if($(".this_address").length==0){
					alert("请选择收货地址!");
					return false;
				}
				if(checkedVal){
					e.stopPropagation();
					$(".confirm-table").html("");
					$(".ajax-loader").show();
					$(".confirm-order-address").html("");
					$.post('<!--@php  echo mobile_url('purchase_confirm')@-->',{api: 'get_order',remark:remark,address_id:address_id,freight:freight},function(data){
						if( data.errno == 200){
							$(".confirm-modal").modal({backdrop: 'static', keyboard: false});
							order_id = data.message.order_id;
							dataObj = data.message;
							$(".confirm-order-num").text(dataObj.order_sn);
							$(".confirm-order-price").text('￥'+(parseFloat(dataObj.order_total_price)).toFixed(2));
							$(".confirm-modal-price .pay-total-price span").text('￥'+(parseFloat(dataObj.order_total_price)).toFixed(2));
							$(".confirm-modal-price .total-price").text('￥'+(parseFloat(dataObj.order_price)).toFixed(2));
							$(".confirm-modal-price .dispatchprice span").text('￥'+parseFloat((dataObj.freight)).toFixed(2));
							$(".confirm-modal-remark").text(dataObj.remark);
							confirm_address_html = '<span>'+data.message.address_province+'</span><span>'+data.message.address_city+'</span><span>'+data.message.address_area+'</span><span>'+data.message.address_address+'</span>'
							$(".confirm-order-address").append(confirm_address_html);
							$.each(data.message.order_goods,function(n,value){
								confirm_html += "<li><div class='li-left'><div class='lf-product-img col-img'><img src="+value.img+"></div></div><div class='li-right'><div class='product-title'>"+
									"<div class='product-name col-name'>"+value.title+"</div></div><span class='confirm-col-price'>"+
									"<span class='price'>￥"+parseFloat(value.price).toFixed(2)+"</span></span><span class='confirm-col-num'>×"+value.num+"</span></div></li>";
							});
							$(".confirm-table").append(confirm_html);
							$(".ajax-loader").hide();
							$(".confirm-body").show();
						}else{
							alert(data.message);
							return false;
						}
					},"json");
				}else{
					alert("请同意并选择勾选");
				}
				$(".terms-accept").prop("checked",false);
			});
		})
		window.onload=function(){  
	        changeDivHeight(".bodys",44);  
	    }  
	     //当浏览器窗口大小改变时，设置显示内容的高度  
	    window.onresize=function(){  
	         changeDivHeight(".bodys",44);  
			 if ($(".filter").hasClass('move'))
			 {
			     changeDivHeight("html",0); 
			     changeDivHeight("body",0); 
			     $("body").css("overflow","hidden");
			 }
	    }  

		function productName(obj){
			var content_this = $(obj);
				var content_id = content_this.attr("product_id");
				var siblings_detail = 	content_this.siblings(".product-detail");
				var content_len = siblings_detail.find(".modal-body").children().length;
					siblings_detail.modal();
				//如何已有详情直接返回
				if( content_len > 1){
					return false;
				}else{
					$.post("",{type:'get_content',id:content_id},function(data){
						if(data.errno == 200){
							$(".ajax-load").hide();
							siblings_detail.find(".modal-body").append("<div class='modal-body-content'>"+data.message.content+"</div>");
						}else{
							$(".ajax-load").hide();
							alert(data.message);
						}
					},'json')
				};
		}

	    //单个选择商品
	    function colcheck(obj){
	    	var add_good_html = "";
				var add_id = $(obj).attr("id");
				var this_check = $(obj);
				var add_num = parseInt(this_check.parents(".col-action").siblings(".col-num").find(".goodsnum").val());
				var addObj = {};
				if( this_check.hasClass("added")){
					return false;
				}else{
					addObj[add_id] = add_num;
					$.post("",{type:"add_goods",goods:addObj},function(data){
						//0添加成功
						if(data.result==0){
							$(".tab .selected span").text(data.max_purchase);
							this_check.addClass("added");
							this_check.text('已选');
						}else if(data.result==1){
							alert(data.info);
						}
					},"json");
				}
	    }
	    function changeDivHeight(obj, h){  
		      if (window.innerHeight)
	             winHeight = window.innerHeight;
	          else if ((document.body) && (document.body.clientHeight))
	             winHeight = document.body.clientHeight;
	       // 通过深入 Document 内部对 body 进行检测，获取窗口大小
	          if (document.documentElement && document.documentElement.clientHeight && document.documentElement.clientWidth){
	               winHeight = document.documentElement.clientHeight;
	          }
	          $(obj).css("height",winHeight-h+"px");  
	     }
	     //显示更多地址
			function addressFun(){
				var address_len = $(".address-area .address_item").length;
		    	if( address_len > 1 ){
		    		$(".address-area .address_item:gt(0)").hide();
		    		$(".hide-more").hide();
		    		$(".show-more").show();
		    	}else{
		    		$(".hide-more").show();
		    		$(".show-more").hide();
		    	}
			}
	     //获取已选商品
	    function getGoods(){
			var get_goods_html = "";
			$(".add-list").html('');
			$(".hide-area").hide();
			$(".ajax_load_hide").show();
			$(".add-list-area-tip").hide();
			$.post("",{type:"get_goods"},function(data){
				$(".tab .selected span").text(data.max_purchase);
				//0成功
				if( data.max_purchase == 0){
					$(".add-list-area").hide();
					$(".ajax_load_hide").hide();
					$(".hide-area").hide();
					$(".add-list-area-tip").show();
				}else{
					$(".add-list-area").show();
					$(".hide-area").show();
					$(".ajax_load_hide").show();
					$(".add-list-area-tip").hide();
				}
				if( data.result == 0){
					$(".add-list").html('');
					if($(".currency").val()==1){
						$.each(data.purchase,function(n,value){
						get_goods_html +="<li><div class='li-left'><div class='lf-product-img'><img class='' src="+value.img+"></div></div><div class='li-right'><div class='product-title'><div class='product-name' product_id="+value.id+">"+
							""+value.title+"</div></div><div class='product-price'>单价：<span><i class='currency-span'>$</i>"+value.price+"</span></div>"+
							"<div class='col-total'>合计：<i class='currency-span'>$</i><span>"+parseFloat(value.price*value.num).toFixed(2)+"</span>"+
							"</div><div class='col-num' cartid="+value.id+"><div class='input-group'><span class='input-group-btn'><button class='btn btn-default btn-sm btn-reduce' type='button' "+
							"onclick='reduceNewNum("+value.id+",this)'>-</button></span><input type='tel' value="+value.num+" class='form-control input-sm pricetotal goodsnum goodsnum_"+value.id+"' "+
							"onblur='blurNewNum(this)' cartid="+value.id+" price="+value.price+"  maxbuy="+value.total+"><span class='input-group-btn'><button class='btn btn-default btn-sm btn-add' "+
							"type='button' onclick='addNewNum("+value.id+","+value.total+",this)'>+</button></span></div></div><div class='remove' onclick='removelist(this)' id="+value.id+"><span class='remove-span' ><img src='__RESOURCE__/recouse/images/delete.png'></span></div></div></li>"; 
						});
					}else if($(".currency").val()==2){
						$.each(data.purchase,function(n,value){
						get_goods_html +="<li><div class='li-left'><div class='lf-product-img'><img class='' src="+value.img+"></div></div><div class='li-right'><div class='product-title'><div class='product-name' product_id="+value.id+">"+
							""+value.title+"</div></div><div class='product-price'>单价：<span><i class='currency-span'>$</i>"+value.price+"</span></div><div class='shippingPrice'>运费：<i class='currency-span'>$</i>"+
							"<span>"+parseFloat(value.freight).toFixed(3)+"</span></div><div class='col-total'>合计：<i class='currency-span'>$</i><span>"+parseFloat(value.price*value.num).toFixed(2)+"</span>"+
							"</div><div class='col-num' cartid="+value.id+"><div class='input-group'><span class='input-group-btn'><button class='btn btn-default btn-sm btn-reduce' type='button' "+
							"onclick='reduceNewNum("+value.id+",this)'>-</button></span><input type='tel' value="+value.num+" class='form-control input-sm pricetotal goodsnum goodsnum_"+value.id+"' "+
							"onblur='blurNewNum(this)' cartid="+value.id+" price="+value.price+"  maxbuy="+value.total+"><span class='input-group-btn'><button class='btn btn-default btn-sm btn-add' "+
							"type='button' onclick='addNewNum("+value.id+","+value.total+",this)'>+</button></span></div></div><div class='remove' onclick='removelist(this)' id="+value.id+"><span class='remove-span' ><img src='__RESOURCE__/recouse/images/delete.png'></span></div></div></li>"; 
						});
					}
					
					$(".add-list").append(get_goods_html);
					currency();
					//已选商品金额合计
					var freight_check = $(".freight-area input[type='radio']:checked").val()||0;
					$(".total-area .total-price").text("￥"+data.goods_price);
					if( freight_check == 0 ){
						$(".total-area .dispatchprice span").removeClass("userself");
						$(".total-area .pay-total-price span").text("￥"+data.total_price);
					}else if(freight_check == 1){
						$(".total-area .dispatchprice span").addClass("userself");
						$(".total-area .pay-total-price span").text("￥"+data.goods_price);
					}
					//运费合计
					$(".total-area .dispatchprice span").text("￥"+data.shiprice);
					$(".ajax_load_hide").hide();
				}else{
					alert(data.info);
				}
			},"json");
		}

		function addNewNum(id,maxbuy,obj){	
			var mb = maxbuy;
			var addObj = {};
			var price = $(obj).parents(".input-group-btn").siblings(".goodsnum").attr("price");
			var num = parseInt( $(".goodsnum_" + id).val() ) + 1;
			/*if(num>mb && mb>0){
				num = mb;
				return;
			}*/
			addObj[id] = num;
			$(".ajax_load").show();
			$.post("",{type:"add_goods",goods:addObj},function(data){
				//0添加成功
				if( data.result == 0){
					$.post("",{type:'get_goods',id:id},function(shipsdata){
						if(shipsdata.result == 0){
							$(obj).parents(".col-num").siblings(".shippingPrice").find("span").text(parseFloat(shipsdata.purchase[id].freight).toFixed(3));
								//已选商品金额合计
								var freight_check = $(".freight-area input[type='radio']:checked").val()||0;
								$(".total-area .total-price").text("￥"+shipsdata.goods_price);
								if( freight_check == 0 ){
									$(".total-area .dispatchprice span").removeClass("userself");
									$(".total-area .pay-total-price span").text("￥"+shipsdata.total_price);
								}else if(freight_check == 1){
									$(".total-area .dispatchprice span").addClass("userself");
									$(".total-area .pay-total-price span").text("￥"+shipsdata.goods_price);
								}
								//运费合计
								$(".total-area .dispatchprice span").text("￥"+shipsdata.shiprice);
								$(".goodsnum_" + id).val(num);
								$(obj).parents(".col-num").siblings(".col-total").find("span").text(parseFloat(price*num).toFixed(2));
								$(".ajax_load").hide();
							}
							
					},'json');
				}else if(data.result == 1){
					alert(data.info);
				}else if(data.result == 2){
					$.post("",{type:'get_goods',id:id},function(shipsdata){
						if(shipsdata.result == 0){
							$(obj).parents(".col-num").siblings(".shippingPrice").find("span").text(parseFloat(shipsdata.purchase[id].freight).toFixed(3));
								//已选商品金额合计
								var freight_check = $(".freight-area input[type='radio']:checked").val()||0;
								$(".total-area .total-price").text("￥"+shipsdata.goods_price);
								if( freight_check == 0 ){
									$(".total-area .dispatchprice span").removeClass("userself");
									$(".total-area .pay-total-price span").text("￥"+shipsdata.total_price);
								}else if(freight_check == 1){
									$(".total-area .dispatchprice span").addClass("userself");
									$(".total-area .pay-total-price span").text("￥"+shipsdata.goods_price);
								}
								//运费合计
								$(".total-area .dispatchprice span").text("￥"+shipsdata.shiprice);
								$(".goodsnum_" + id).val(num);
								$(obj).parents(".col-num").siblings(".col-total").find("span").text(parseFloat(price*num).toFixed(2));
							$(".goodsnum_" + id).val(num);
							$(obj).parents(".col-num").siblings(".col-total").find("span").text(parseFloat(price*num).toFixed(2));
							$(".ajax_load").hide();
						}
						
					},'json');
				}
				
			},"json");
			//如果网络断开连接 三秒后自动隐藏加载动画
			setTimeout(function(){
				$(".ajax_load").hide();
			},3000)
		}
		function reduceNewNum(id,obj){
			var num = parseInt( $(".goodsnum_" + id).val() );
			var reduceObj = {};
			if(num-1<=0){
				return;
			}
			num--;
			reduceObj[id] = num;
			$(".ajax_load").show();
			$.post("",{type:"add_goods",goods:reduceObj},function(data){
				//0添加成功
				if( data.result == 0){
					$.post("",{type:'get_goods',id:id},function(shipsdata){
						if(shipsdata.result == 0){
							$(obj).parents(".col-num").siblings(".shippingPrice").find("span").text(parseFloat(shipsdata.purchase[id].freight).toFixed(3));
							//已选商品金额合计
								var freight_check = $(".freight-area input[type='radio']:checked").val()||0;
								$(".total-area .total-price").text("￥"+shipsdata.goods_price);
								if( freight_check == 0 ){
									$(".total-area .dispatchprice span").removeClass("userself");
									$(".total-area .pay-total-price span").text("￥"+shipsdata.total_price);
								}else if(freight_check == 1){
									$(".total-area .dispatchprice span").addClass("userself");
									$(".total-area .pay-total-price span").text("￥"+shipsdata.goods_price);
								}
								//运费合计
							$(".total-area .dispatchprice span").text("￥"+shipsdata.shiprice);	

							$(".goodsnum_" + id).val(num);
							var price = $(obj).parents(".input-group-btn").siblings(".goodsnum").attr("price");
							$(obj).parents(".col-num").siblings(".col-total").find("span").text(parseFloat(price*num).toFixed(2));
							$(".ajax_load").hide();
						}
					},'json');
				}else if(data.result == 1){
					alert(data.info);
				}else if(data.result == 2){
					
				}
				
			},"json");
			//如果网络断开连接 三秒后自动隐藏加载动画
			setTimeout(function(){
				$(".ajax_load").hide();
			},3000)
		}
		//价格符号值的显示。
		function currency(){
			if($(".currency").val()==1){
				$(".currency-span").text("￥");
			}else{
				$(".currency-span").text("$");
			};
		}
		

		//选择商品失去焦点方法
		function blurNum(obj){
			var id = $(obj).attr("cartid");
		        var goodsnum_this = $(obj);
		        var reg = new RegExp("^[0-9]*$");
		        if(reg.test($(obj).val())){
		            var num = parseInt( $(obj).val() );
		            var maxbuy = parseInt( $(obj).attr("maxbuy") );
		            var mb = maxbuy;
		            /*if(num>mb && mb>0){
		                alert("最多只能购买 " + mb + " 件!",true);
		                $(this).val(mb);
		                num = mb;
		                var price = parseFloat( $("#singleprice_"+id).html() ) * num;
		                $(this).html(price.toFixed(2));

		                return;
		            }*/
		            if (num <=0 || isNaN(num)){
		                $(obj).val(1); 
		                num = 1;
		            }
		        }else{
		            $(obj).val("1");
		        }
		}
		function blurNewNum(obj){

		        var id = $(obj).attr("cartid");
		        var goodsnum_this = $(obj);
		        var reg = new RegExp("^[0-9]*$");
		        var blurObj = {};
		        var price = 0;
		        var freight = $(goodsnum_this).parents(".col-num").siblings(".shippingPrice").find("span").text();
		        $(".ajax_load").show();
		        if(reg.test($(obj).val())){
		            var num = parseInt( $(obj).val() );
		            var maxbuy = parseInt( $(obj).attr("maxbuy") );
		            var mb = maxbuy;

		            /*if(num>mb && mb>0){
		                alert("最多只能购买 " + mb + " 件!",true);
		                $(this).val(mb);
		                num = mb;
		                var price = parseFloat( $("#singleprice_"+id).html() ) * num;
		                $(this).html(price.toFixed(2));

		                return;
		            }*/
		            if (num <=0 || isNaN(num)){
		                $(obj).val(1); 
		                num = 1;
		            }
					blurObj[id] = num;
					
					$.post("",{type:"add_goods",goods:blurObj},function(data){
						//0添加成功
						if( data.result == 0 ){
							$.post("",{type:'get_goods',id:id},function(shipsdata){
								if(shipsdata.result == 0){
									goodsnum_this.parents(".col-num").siblings(".shippingPrice").find("span").text(parseFloat(shipsdata.purchase[id].freight).toFixed(3));
									//已选商品金额合计
								var freight_check = $(".freight-area input[type='radio']:checked").val()||0;
								$(".total-area .total-price").text("￥"+shipsdata.goods_price);
								if( freight_check == 0 ){
									$(".total-area .dispatchprice span").removeClass("userself");
									$(".total-area .pay-total-price span").text("￥"+shipsdata.total_price);
								}else if(freight_check == 1){
									$(".total-area .dispatchprice span").addClass("userself");
									$(".total-area .pay-total-price span").text("￥"+shipsdata.goods_price);
								}
								//运费合计
								$(".total-area .dispatchprice span").text("￥"+shipsdata.shiprice);					
									$(".goodsnum_" + id).val(num);
									goodsnum_this.parents(".col-num").siblings(".col-total").find("span").text(parseFloat(goodsnum_this.attr("price")*num).toFixed(2));
									$(".ajax_load").hide();
								}
							},'json');
						}else if(data.result == 1){
							alert(data.info);
						}else if(data.result == 2){
							$.post("",{type:'get_goods',id:id},function(shipsdata){
								if(shipsdata.result == 0){
									goodsnum_this.parents(".col-num").siblings(".shippingPrice").find("span").text(parseFloat(shipsdata.purchase[id].freight).toFixed(3));
									//已选商品金额合计
								var freight_check = $(".freight-area input[type='radio']:checked").val()||0;
								$(".total-area .total-price").text("￥"+shipsdata.goods_price);
								if( freight_check == 0 ){
									$(".total-area .dispatchprice span").removeClass("userself");
									$(".total-area .pay-total-price span").text("￥"+shipsdata.total_price);
								}else if(freight_check == 1){
									$(".total-area .dispatchprice span").addClass("userself");
									$(".total-area .pay-total-price span").text("￥"+shipsdata.goods_price);
								}
								//运费合计
								$(".total-area .dispatchprice span").text("￥"+shipsdata.shiprice);					
									$(".goodsnum_" + id).val(num);
									goodsnum_this.parents(".col-num").siblings(".col-total").find("span").text(parseFloat(goodsnum_this.attr("price")*num).toFixed(2));
									$(".ajax_load").hide();
								}
							},'json');
							
						}
						
						
					},"json");
					//如果网络断开连接 三秒后自动隐藏加载动画
						setTimeout(function(){
							$(".ajax_load").hide();
						},3000)
		        }else{
		            $(obj).val("1");
		            var price = parseFloat( $("#singleprice_"+id).html() ) * 1;
		            $("#goodsprice_" + id).html(parseFloat(price).toFixed(2));
		            $(obj).parents(".col-num").siblings(".col-total").find("span").text(parseFloat($(obj).attr("price"))*1);

					blurObj[id] = 1;
					$.post("",{type:"add_goods",goods:blurObj},function(data){
						//0添加成功
						if( data.result == 0 ){
							$.post("",{type:'get_goods',id:id},function(shipsdata){
								if(shipsdata.result == 0){
									goodsnum_this.parents(".col-num").siblings(".shippingPrice").find("span").text(parseFloat(shipsdata.purchase[id].freight).toFixed(3));
									//已选商品金额合计
								var freight_check = $(".freight-area input[type='radio']:checked").val()||0;
								$(".total-area .total-price").text("￥"+shipsdata.goods_price);
								if( freight_check == 0 ){
									$(".total-area .dispatchprice span").removeClass("userself");
									$(".total-area .pay-total-price span").text("￥"+shipsdata.total_price);
								}else if(freight_check == 1){
									$(".total-area .dispatchprice span").addClass("userself");
									$(".total-area .pay-total-price span").text("￥"+shipsdata.goods_price);
								}
								//运费合计
								$(".total-area .dispatchprice span").text("￥"+shipsdata.shiprice);					
									goodsnum_this.parents(".col-num").siblings(".col-total").find("span").text(parseFloat(goodsnum_this.attr("price")*1).toFixed(2));
								}
							},'json');
						}else if(data.result == 1){
							alert(data.info);
						}else if(data.result == 2){
							
						}
						$(".ajax_load").hide();
					},"json");
					//如果网络断开连接 三秒后自动隐藏加载动画
					setTimeout(function(){
						$(".ajax_load").hide();
					},3000)
		        }
		}
		function freightFun(){

	    	$.post("",{type:"get_goods"},function(data){
	    		if(data.result == 0){
	    			//已选商品金额合计
					var freight_check = $(".freight-area input[type='radio']:checked").val()||0;
					$(".total-area .total-price").text("￥"+data.goods_price);
					if( freight_check == 0 ){
						$(".total-area .dispatchprice span").removeClass("userself");
						$(".total-area .pay-total-price span").text("￥"+data.total_price);
					}else if(freight_check == 1){
						$(".total-area .dispatchprice span").addClass("userself");
						$(".total-area .pay-total-price span").text("￥"+data.goods_price);
					}
					//运费合计
					$(".total-area .dispatchprice span").text("￥"+data.shiprice);
	    		}else{
	    			alert(data.info);
	    		}
	    		
		    },"json")

		}
		//选择商品加号按钮方法
		function addNum(id,maxbuy){	
			var mb = maxbuy;
			var stock =$("#stock_" + id).html()==''?-1:parseInt($("#stock_" + id).html());
			if(mb>stock && stock!=-1){
				mb = stock;
			}
			var num = parseInt( $("#goodsnum_" + id).val() ) + 1;
			/*if(num>mb && mb>0){
				alert("最多只能购买 " + mb + " 件!",true);
				return;
			}*/
			$("#goodsnum_" + id).val(num);
		}
		//选择商品减号方法
		function reduceNum(id){
			var num = parseInt( $("#goodsnum_" + id).val() );
			if(num-1<=0){
				return;
			}
			num--;
			$("#goodsnum_" + id).val(num);
		}
		function openDialog(url){
		    $('.address').attr("src",url);
		    $('.address').show();
			$('.iDialogLayout').show();
			$(".address-detail").modal();
		}
		function setaddress(ids){
		     $(".this_address").removeClass("this_address");
			 $(".address_"+ids).addClass("this_address");
		     $("#addressval").val(ids);
		     $("#addresslist .set").each(function(){
				if($(this).text()=="默认地址"){
					//$("#addresslist .set").hide();
					$(this).show();
				}
			});
		}
		function setdefault(ids){			
		     $.post('<!--@php  echo mobile_url("purchase_address")@-->', {'id' : ids,'op':'default_ajax'}, function(s) {		
				   if (s.result == 1){		
				        $(".default_address").removeClass("default_address");
						$(".address_"+s.id+" .set").addClass("default_address");
						$(".set").text('设为默认');
						$(".default_address").text('默认地址');
				   }
		     }, 'json');          
		}
		//删除
		function addressDel(addsid){		
			if(confirm('确认要删除此收货地址吗?')){		
				$.post("<!--@php  echo mobile_url('purchase_address', array('op' =>'remove'))@-->", {'id' : addsid,'del':'del'}, function(s) {
					if (s.result == 1){					
				        $(".address_"+addsid).remove();
						if (parseInt(s.maxid) > 0){
						     $(".default_address").removeClass("default_address");
						     $(".address_"+s.maxid+" .set").addClass("default_address");
							 if (parseInt($("#addressval").val()) == parseInt(addsid)){				      
							      $(".address_"+s.maxid).addClass("this_address");
						          $("#addressval").val(s.maxid);
						     }
						}else{
		                     $("#addressval").val('');
						}
			       }
					//不管成功还是失败，都提示消息
				   alert(s.message);
				   if($(".address-area .address_item").first().length > 0){
				   	  $(".address-area .address_item").first().show();
				   }
				   
				},'json');
				
		    }
		}
		function removelist(obj){
			var remove_this = $(obj);
			var removeId = $(obj).attr("id");
			$.post("",{type:"del_good",id:parseInt(removeId)},function(data){
				if(data.result==0){
					if($('#product-list .col-action span[id='+removeId+']').length!=0){
						$('#product-list .col-action span[id='+removeId+']').removeClass("added").text("选择");
					}
					getGoods();
				}else{
					alert(data.info);
				}
			},"json");
		}
		function topay() {
			var paycode = $("#pays").val();
			window.open("<!--@php  echo mobile_url('purchase_pay')@-->&paymentcode="+paycode+"&orderid="+order_id);
		}	
	</script>
</body>
</html>