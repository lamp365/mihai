<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
     <meta charset="utf-8">
    <title>订单确认</title>
    
    <meta name="viewport" content="initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no">
    <!--@php css_url('confirm'); @-->
    <!--@php js_url('jquery-1.10.2.min'); @-->
  </head>
<body>

<section class="accounts">
<div class="infobox">
 <h2>收货信息</h2>
   <!--@php  if(!empty($defaultAddress)) { @-->
 
 <p class="address_item address_xinxi">
     <!--@php  echo $defaultAddress['realname'];@--> <span style="float: right;"><!--@php  echo $defaultAddress['mobile'];@--></span><br/>
     <!--@php  echo $defaultAddress['province'];@--> <!--@php  echo $defaultAddress['city'];@--> <!--@php  echo $defaultAddress['area'];@--> <!--@php  echo $defaultAddress['address'];@--> </p>
<p><button type="button" class="btn btn-danger" onclick="location.href='<!--@php  echo mobile_url('address',array('from'=>'confirm','returnurl'=>urlencode($returnurl)))@-->'"><i class="icon-plus"></i>管理收货地址</button></p>
	  <!--@php  } else { @-->
	<div style="padding: 15px;"><button type="button" class="btn btn-danger" onclick="location.href='<!--@php  echo mobile_url('address',array('from'=>'confirm','returnurl'=>urlencode($returnurl)))@-->'"><i class="icon-plus"></i> 添加收货地址</button></div>
		<!--@php  } @-->

</div>

 	 <form id='formorder' name="input" onsubmit="return check()" method="post">
 	<input type="hidden" name="goodstype" value="<!--@php  echo $goodstype;@-->" />
<input type="hidden" name="address" value="<!--@php  echo $defaultAddress['id'];@-->" />

 <!--@php if (is_array($dispatch) && !empty($dispatch)){ @-->
 <div class="infobox">
     <h2>配送方式</h2>
     <ul class="payStyle">
         <!--@php  foreach($dispatch as $d) { @-->
         <li><label><input name='dispatch' class='dispatch' dt="<!--@php  echo $d['sendtype'];@-->" onchange='oncheckboxchange("<!--@php echo $issendfree==1?0:$d['price']@-->",this);' type="radio"  value="<!--@php  echo $d['id'];@-->"  /><img src="__RESOURCE__/recouse/images/icon-wein.png" /><!--@php  echo $d['dname'];@--></label></li>
         <!--@php  } @-->
     </ul>
 </div>
 <!--@php } @-->

 
<div class="infobox">
 <h2>支付方式</h2>
  <ul class="payStyle payWay" id="_0">
      <li><label>请选择支付方式</label></li>
 </ul>
    <ul class="payStyle payWay" id="_<!--@php echo $d['id'];@-->">
        <!--@php  if(is_array($payments)) { foreach($payments as $v) { @-->
        <li><label><input name='payment'  type="radio"  value="<!--@php echo $v['code']@-->"  <!--@php if($v['code'] == 'weixin') echo "checked='checked'"; @-->/><img src="__RESOURCE__/recouse/images/icon-<!--@php echo $v['code']@-->.png" /><!--@php echo $v['name']@--></label></li>
        <!--@php  }  } else { echo '<li><label>请配置支付方式</label></li>'; } @-->
    </ul>
</div>

<div class="my-memvers">
  <div class="member-browse">
        <h2 class="member-browse-title"><span>订单详情</span></h2>
        <ul class="member-browse-ul">
            <li class="member-browse-li">
                <div class="order-from"><i class="circle-icon"></i>由红色小象从浙江省,杭州市发货</div>
                <div class="member-browser-pro-list">
                    <div class="member-browser-pro-a"><span class="pro-img">
                        <img src="http://odozak4lg.bkt.clouddn.com/20161125101958379fa583a27.jpg"></span>
                        <p class="pro-info">
                            <span class="pro-title">Neocell修复型水解胶原蛋白粉小分子蛋白肽女性美白滋养润泽防皱抗皱正品</span>
                            <span class="pro-spec">通用, 手口专用</span>
                            <div>
                              <span class="pro-name">78.00</span>
                              <span class="pro-num"> × 4</span>
                            </div>
                        </p>
                    </div>
                </div>
                <div class="member-browser-pro-list">
                    <div class="member-browser-pro-a"><span class="pro-img">
                        <img src="http://odozak4lg.bkt.clouddn.com/20161125101958379fa583a27.jpg"></span>
                        <p class="pro-info">
                            <span class="pro-title">Neocell修复型水解胶原蛋白粉小分子蛋白肽女性美白滋养润泽防皱抗皱正品</span>
                            <span class="pro-spec">通用, 手口专用</span>
                            <div>
                              <span class="pro-name">78.00</span>
                              <span class="pro-num"> × 4</span>
                            </div>
                        </p>
                    </div>
                </div>
                <div class="order-sum">
                    <div>
                        <span class="u-sum-left">小计：</span>
                        <span class="u-sum-right xj">¥114.00</span>
                    </div>
                </div>
                <div class="order-remark">             
                    <input data-eventid="310828" type="text" value="" placeholder="买家留言（选填）">         
                </div>
            </li>
            <li class="member-browse-li">
                <div class="order-from"><i class="circle-icon"></i>由红色小象从浙江省,杭州市发货</div>
                <div class="member-browser-pro-list">
                    <div class="member-browser-pro-a"><span class="pro-img">
                        <img src="http://odozak4lg.bkt.clouddn.com/20161125101958379fa583a27.jpg"></span>
                        <p class="pro-info">
                            <span class="pro-title">Neocell修复型水解胶原蛋白粉小分子蛋白肽女性美白滋养润泽防皱抗皱正品</span>
                            <span class="pro-spec">通用, 手口专用</span>
                            <div>
                              <span class="pro-name">78.00</span>
                              <span class="pro-num"> × 4</span>
                            </div>
                        </p>
                    </div>
                </div>
                <div class="order-sum">
                    <div>
                        <span class="u-sum-left">小计：</span>
                        <span class="u-sum-right xj">¥114.00</span>
                    </div>
                </div>
                <div class="order-remark">             
                    <input data-eventid="310828" type="text" value="" placeholder="买家留言（选填）">         
                </div>
            </li>
                    
        </ul>
    </div>
</div>



 <div class="infobox">
     <h2><!--@php if( is_array($change_goods) ){ echo ' 您的金额满399元可换购'; }else{ echo '订单金额达到399元可参与换购'; } @--></h2>
     <ul class="os_box_list">
         <!--@php if( is_array($change_goods) ){ foreach ( $change_goods as $item ){ @-->
         <li>
             <div class="item">
                 <div class="img">
                     <a href="<!--@php  echo mobile_url('detail', array('id' => $item['gid']))@-->" class="item" target="_blank" >
                         <img data-original="<!--@php  echo $item['thumb']; @-->" class="lazy" src="images/loading.gif" >
                     </a>
                 </div>
                 <!--商品描述-->
                 <div class="txt">
                     <a href="<!--@php  echo mobile_url('detail', array('id' => $item['gid']))@-->" class="item" target="_blank" style="width:100%;overflow:hidden;">
                         <!--@php echo $item['title']@-->
                     </a>
                 </div>
                 <!--数量选择-->
                 <div class="input-btn" >
                     <input type="button" value="-" class="btn reduceNum" />
                     <!--max_buy可以购买数量 data-kucun是库存-->
                     <input type="text" id="num_<?php echo $item['id'];?>" name="number" value="1" class="text" max_buy="<?php echo $item['max_buy'];?>" data-kucun="<?php echo $item['total'];?>"/>
                     <input type="button" value="+" class="btn addNum"/>
                 </div>

                 <!--价格和加入换购-->
                 <div class="os_box_list_footer">
                      <span class="footer-01">
                        <span class="footer-02">
                          <span class="footer-03">￥</span>
                            <!--现价-->
                          <span id="" class="realprice"><!--@php echo round($item['marketprice'],2) @--></span>
                        </span>
                          <!--原价-->
                        <del class="footer-del" >￥<!--@php echo round($item['productprice'],2)@--></del>
                      </span>
                     <span class="addredemption" onclick="addredemption('<!--@php echo $item['id']; @-->',0)" >换购</span>
                 </div>
             </div>
         </li>
        <!--@php }} @-->
     </ul>
 </div>



 <div class="infobox">
     <h2>优惠券</h2>
     <div class="payStyle">
      <select>
        <option value="1">满320减60元新手礼券</option>
        <option value="1">满320减600元新手礼券</option>
        <option value="1">满320减6000元新手礼券</option>
      </select>
     </div>
 </div>


<div class="infobox ">
    <div class="jiesuan_xinix"><strong>结算</strong></div>
    <div class="jiesuan_xinix balance">
        <label>
        <!--@php if($user_balance != 0){ @-->
        <input style="margin-top: -2px;" type="checkbox" name="balance" value="1">
        <!--@php } @-->
        余额抵扣(¥<!--@php echo $user_balance; @-->)</label><span class="balance-value-num">0.00</span><span >¥ </span>
    </div>
    <div class="jiesuan_xinix">商品总额 <span class="zonge"><!--@php  echo number_format($totalprice,2,'.','');@--></span><span >¥ </span></div>
    <div class="jiesuan_xinix">运费 <span class="yunfei"><!--@php  echo number_format($dispatchprice,2,'.','');@--></span><span >¥ </span></div>
    <div class="jiesuan_xinix">税费 <span class="shuifei"><!--@php  echo number_format($taxtot,2,'.','');@--></span><span >¥ </span></div>
    <div class="jiesuan_xinix">商品优惠 <span class="youhui">0.00</span><span><i>-</i>¥ </span></div>
    <div class="jiesuan_xinix">应付金额 <span class="jinge"><!--@php  echo number_format(($totalprice+$taxtot+$dispatchprice),2,'.','');@--></span><span >¥ </span></div>
</div>

<div class="carFoot">
  <button type="submit" id='submit'  name="submit" value="yes" >提交订单</button>
  <p>
    <span>合计：</span>
    <i class="price">
      <span > ¥</span>
      <span id='totalprice'><!--@php  echo  number_format(($totalprice+$taxtot+$dispatchprice),2,'.','');@--></span>
    </i>
  </p>
</div>
	<input type="hidden" name="token" value="<!--@php  echo $_SESSION['token'];@-->" />
</form>
</section>
<script src="__RESOURCE__/recouse/js/zepto.min.js" type="text/javascript"></script>
<script type="text/javascript"	src="__RESOURCE__/recouse/js/jquery.lazyload.min.js"></script>
<script type="text/javascript">
Zepto(function($){
   var $nav = $('.global-nav'), $btnLogo = $('.global-nav__operate-wrap');
   //点击箭头，显示隐藏导航
   $btnLogo.on('click',function(){
     if($btnLogo.parent().hasClass('global-nav--current')){
       navHide();
     }else{
       navShow();
     }
   });
   var navShow = function(){
     $nav.addClass('global-nav--current');
   }
   var navHide = function(){
     $nav.removeClass('global-nav--current');
   }
   
   $(window).on("scroll", function() {
		if($nav.hasClass('global-nav--current')){
			navHide();
		}
	});
})
function get_search_box(){
	try{
		document.getElementById('get_search_box').click();
	}catch(err){
		document.getElementById('keywordfoot').focus();
 	}
}

$(function() {
    $("img.lazy").lazyload({
        threshold : 50,
        failure_limit : 10,
        effect : "fadeIn"
    });
});
</script>




        <script language='javascript'>
    
			function changeAddress(){
                location.href = "<!--@php  echo mobile_url('address', array('from'=>'confirm','returnurl'=>urlencode($returnurl)))@-->";
            }
            function check(){
			    if ($(".dispatch:checked").attr('dt') !=1)
			    {
                    if($(".address_item").length <= 0 ){
                        tip("请添加收货地址!",2000);
                        return false;
                    }
			    }
    
                 if($('input[name="dispatch"]:checked').val()!=null)
                 {
                 	
                 }else{
                		/*alert("请选择配送方式");
                		  return false;*/
                  }
          
                  if($('input[name="payment"]:checked').val()!=null)
                 {
                 	
                 }else{
                		tip("请选择支付方式",2000);
                		  return false;
                 }
          
                 	return true;
            }
       
            function oncheckboxchange(dispatchpricestr,_this){
                var price = 0;
				var sendWay = _this.value;
                $(".payWay").hide();
				$("#_"+sendWay).show();
                $(".goodsprice").each(function(){
                    price+=parseFloat($(this).html());
                });
                var dispatchprice = parseFloat(dispatchpricestr);
                if(dispatchprice>0){
                   $("#totalprice").html(price + dispatchprice + " 元 (含运费"+dispatchprice + ")");    
                 
                  $("#dispatchshow").css('display','block');
                  
                  $("#dispatchshow_price").html(dispatchprice);    
                   $("#dispatchshow_name").html($("#dispatch").find("option:selected").attr("dispatchname"));    
 
                }
                else{
                    $("#totalprice").html(price);    
                       $("#dispatchshow").css('display','none');
                }
                
            }

    function tip(msg,time=false){
        var div = $("#poptip");
        var content =$("#poptip_content");
        if(div.length<=0){
            div = $("<div id='poptip'></div>").appendTo(document.body);
            content =$("<div id='poptip_content'>" + msg + "</div>").appendTo(document.body);
        }else{
            content.html(msg);
            content.show();
            div.show();
        }
        if(time) {
            time =  isNaN(time)? '1000' : time;
            setTimeout(function(){
                content.fadeOut(500);
                div.fadeOut(500);

            },time);
        }
    }
    function tip_close(){
        $("#poptip").fadeOut(500);
        $("#poptip_content").fadeOut(500);
    }
  $(".text").on("blur",function(){
    var thisVal = parseInt($(this).val());
    var thisMaxVal = parseInt($(this).data("kucun"));      //库存
    var thisLimitVal = parseInt($(this).attr("max_buy"));  //最大购买  为0时不做限制
    var reg = new RegExp("^[0-9]*$");
    if( thisVal <= 0 ){
      $(this).val(1);
    }
    if( thisLimitVal == 0 ){
      if( thisVal > thisMaxVal ){
        $(this).val(thisMaxVal);
      }
    }else{
      if( thisLimitVal > thisMaxVal ){
        if( thisVal > thisMaxVal ){
          $(this).val(thisMaxVal);
        }
      }else{
        if( thisVal > thisLimitVal ){
          $(this).val(thisLimitVal);
        }
      }
    }
    if( !reg.test(thisVal)){
      $(this).val(1);
    }
  })
  $(".reduceNum").on("click",function(){
    var numberText = $(this).siblings(".text");
    var num =  numberText.val();
    if( num >= 2 ){
      num--;
      numberText.val(num);
    }
  });
  $(".addNum").on("click",function(){
    var numberText = $(this).siblings(".text");
    var numLimit = parseInt(numberText.attr("max_buy"));  //为0时表示不限制
    var num = parseInt(numberText.val());
    var max = parseInt(numberText.data("kucun"));
    if( numLimit == 0){
      if( num < max){
        num++;
        numberText.val(num);
      }
    }else{
      if( numLimit > max){
        if( num < max){
          num++;
          numberText.val(num);
        }
      }else if( numLimit <= max ){
        if( num < numLimit){
          num++;
          numberText.val(num);
        }
      }
    }
  })

//点击加入换购按钮
var add = 0//默认没有加入换购
function addredemption(id,todo){
    var num   = parseInt($('#num_'+id).val());
    var kucun = parseInt($("#num_"+id).data('kucun'));
    var max   = parseInt($("#num_"+id).attr('max_buy'));
    if(num<=0){
        tip('数字输入有误！',1500);
        $('#num_'+id).val(1);
        return;
    }

    if(num>max && max !=0){  //0不做限制
        tip('此商品最多只能换购'+max+'个',1500);
        $('#num_'+id).val(max);
        return;
    }
    if(num > kucun){
        tip('库存只剩下'+kucun+'个',1500);
        $('#num_'+id).val(kucun);
        return;
    }
    tip('正在处理');
    $.post('',{'ajax':'ajax','change_goods_id':id,'change_goods_num':num,'todo':todo},function(s){
        if (s.result == 1)
        {
            tip('换购成功！',1000);
            $(".member-browse .member-browse-ul").append(s.text);
            delcountprice();
        }else if(s.result == 2){
            tip('删除成功！',1500);
            delredemption();
            delcountprice();
        }else{
            tip(s.text,1500);
        }
    },'json');
}
//删除换购
function delredemption(){
    var demption = $(".change_goods");
    demption.remove();
}
//删除换购计算金额
function delcountprice(){
    $.post('',{'ajax':'get_detail'},function(s){
        var goodvalue = s.total; //商品价格
        var dispatchprice = s.ships;//运费
        var taxtot   =  s.tax;//税费
        var discount = parseFloat($(".youhui").html()).toFixed(2);//商品优惠
        $(".zonge").html(parseFloat(goodvalue).toFixed(2));
        $(".yunfei").html(parseFloat(dispatchprice).toFixed(2));
        $(".shuifei").html(parseFloat(taxtot).toFixed(2));
        var total   = parseFloat(goodvalue) + parseFloat(dispatchprice) + parseFloat(taxtot) - parseFloat(discount)-parseFloat(balance);

        var last_total = goodvalue + dispatchprice + taxtot;
        var new_total = "";//应付金额
        new_total = goodvalue + dispatchprice + taxtot - discount-balance;

        if($(".balance input[name=balance]").prop("checked")){
          $(".balance-value-num").text(parseFloat(balance).toFixed(2));
        }
        if( $(".payStyle input[name=bonus]:checked").val() != 0 ){
          if( parseFloat(balance) > parseFloat(last_total-discount) ){
            $(".balance-value-num").text(parseFloat(last_total-discount).toFixed(2));
            new_total = '0.00';
          }
        }else{
          if( parseFloat(balance) > parseFloat(last_total) ){
            $(".balance-value-num").text(parseFloat(last_total).toFixed(2));
            new_total = '0.00';
          }
        }
        $(".jinge").html(parseFloat(new_total).toFixed(2)); //应付金额，保留两位小数
        $("#totalprice").html(parseFloat(new_total).toFixed(2));
    },'json');
}

$(".sel_bonus").click(function(){
    //如果选择不使用优惠券，则优惠金额显示0
    if($(this).val() == 0){
        $(".youhui").html("0.00");

        delcountprice();
       // countprice();//调用计算应付金额函数
        return;
    }
    //异步传的值是select的value
    var bonusvalue = $(this).val();
    var url        = "<!--@php echo mobile_url('bonus');@-->";
    $.post(url, {'id' : bonusvalue,'op':'get_price'}, function(s) {
        if (s != 0){
            $(".youhui").html(s); //商品优惠一栏显示值，等于选择的优惠券金额
            delcountprice();
            //countprice();         //调用计算应付金额函数
        }else{
            tip('优惠券错误',1500);
        }
    });
})

//计算应付金额
function countprice(){
    var zonge   = parseFloat($(".zonge").html()).toFixed(2);  //总额
    var yunfei  = parseFloat($(".yunfei").html()).toFixed(2); //运费
    var shuifei = parseFloat($(".shuifei").html()).toFixed(2); //税费
    var youhui  = parseFloat($(".youhui").html()).toFixed(2);  //优惠
    var total   = parseFloat(zonge) + parseFloat(yunfei) + parseFloat(shuifei) - parseFloat(youhui);
    $(".jinge").html(parseFloat(total).toFixed(2)); //应付金额，保留两位小数
    $("#totalprice").html(parseFloat(total).toFixed(2));
}
var balance = 0;
//余额抵扣
$("input[name='balance']").click(function(){
    isChecked = this.checked;
    if(isChecked){
        var url   = "<!--@php echo mobile_url('bonus');@-->";
        $.post(url, {'op':'balance'}, function(s) {
            if (s != 0){
                //结算一栏显示余额抵扣
                balance = s;

                delcountprice();//调用计算应付金额函数
            }else{
                alert('非法操作');
            }
        });
    }else{
        //移除掉余额抵扣
        balance = 0;
        delcountprice();
    }
})
 </script>
            
 


</body>
</html>   