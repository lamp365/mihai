<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<title>购物车</title>
	<meta charset="utf-8">
 <meta name="viewport" content="initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no">
	<script type="text/javascript" src="__RESOURCE__/script/jquery-1.7.2.min.js"></script>
	<script type="text/javascript" src="__RESOURCE__/script/common.js"></script>
	<link type="text/css" rel="stylesheet" href="__RESOURCE__/openshop/css/bootstrap.min.css">
	<script type="text/javascript" src="__RESOURCE__/mobile/script/bootstrap.min.js"></script>
	<script type="text/javascript" src="__RESOURCE__/script/angular.min.js"></script>
	<link type="text/css" rel="stylesheet" href="__RESOURCE__/recouse/css/font-awesome.min.css" />
	<link type="text/css" rel="stylesheet" href="__RESOURCE__/mobile/style/common.mobile.css">
	<script type="text/javascript" src="__RESOURCE__/script/cascade.js"></script>
	<script type="text/javascript" src="__RESOURCE__/mobile/script/jquery.touchwipe.js"></script>
	<script type="text/javascript" src="__RESOURCE__/mobile/script/swipe.js"></script>
</head>

<body style="padding-top:0px; background: #ffffff;">
<div class="main">
<script type="text/javascript" src="__RESOURCE__/mobile/images/jquery.gcjs.js"></script>
<link type="text/css" rel="stylesheet" href="__RESOURCE__/mobile/style/style.css">

<style>
.shopcart-footer{margin-bottom:49px;}

</style>
<div class="cart_title" >
   <span class="return"><img src="__RESOURCE__/openshop/images/return.png" width="10px" height="16px"></span> 购物车(<span id="cart_title_num"><!--@php echo count($list); @--></span>)
</div>
<div class="shopcart-main">

    <div style='text-align:center;padding:50px 0 50px 0; <!--@php  if(count($list)>0) { @-->display:none<!--@php  } @-->' id='cartempty'>
        <img src="__RESOURCE__/mobile/images/icon_cart_empty.png" /><br/><br/>
        <span style='color:#adadad'>您的购物车空空如也，赶紧去选购吧~~</span>
    </div>

    <!--@php  if(is_array($list) && !empty($list)) { @-->
    <div class="shopcart-item">
        <div class="fahuodi">
            <div class="cart_l">
                <input type="checkbox" id="choose_all" class="cart_checkbox" onclick="choose_or_not_choose()"/><label for="choose_all"></label>
            </div>
            <div class="cart_r" style="font-size:12px;">
                全选
                 <button type="button" class="btn btn-danger btn-xs pull-right" id="delbat_btn">删除</button>
            </div>

        </div>

        <form action="<!--@php  echo mobile_url('mycart',array('op'=>'choose_cart'));@-->" method="post" name="cartform">
        <!--@php foreach($list as $key=>$item){ $price += $item['totalprice']; @-->
        <!--@php  $goods = $item['goods']@-->
        <div class="cart_list" id="item_<!--@php  echo $item['id'];@-->">
            <div class="cart_l">
                <input type="checkbox" id="list_index_<!--@php echo $item['id'];@-->" class="cart_checkbox child_checkbox" name="cart_ids[]" value="<!--@php  echo $item['id'];@-->"/><label for="list_index_<!--@php echo $item['id'];@-->"></label>
                <input type="hidden" value="<!--@php  echo $goods['total'];@-->" id="hide_kucun_<!--@php  echo $item['id'];@-->">
            </div>
            <div class="cart_r">
                <div class="pic">
                    <img data-original="<!--@php  echo $goods['thumb'];@-->" class="lazy" src="images/loading.gif">
                </div>

                <div class="shopcart-item-detail">
                    <div class="shop_title">
                        <div class="name"><a href="<!--@php echo mobile_url('detail',array('id'=>$goods['id']));@-->"><!--@php  echo $goods['title'];@--></a></div>
                        <div class="input-group">
						<span class="input-group-btn">
							<button class="btn btn-default btn-sm" type="button" onclick="reduceNum(<!--@php  echo $item['id'];@-->)"><i class="icon-minus"></i></button>
						</span>
                            <input type="tel" class="form-control input-sm pricetotal goodsnum" style="border-left:0;" value="<!--@php  echo $item['total'];@-->" price="<!--@php  echo $goods['marketprice'];@-->" pricetotal="<!--@php  echo $item['totalprice'];@-->" id="goodsnum_<!--@php  echo $item['id'];@-->" cartid="<!--@php  echo $item['id'];@-->" maxbuy="<!--@php  echo $goods['max_buy_quantity'];@-->">
						<span class="input-group-btn">
							<button class="btn btn-default btn-sm" type="button" onclick="addNum(<!--@php  echo $item['id'];@-->,<!--@php  echo $goods['max_buy_quantity'];@-->)"><i class="icon-plus"></i></button>
						</span>
                        </div>
                    </div>
                    <div class="price">
                        ¥<span class="singletotalprice" style="font-weight:bold"><!--@php  echo $goods['marketprice'];@--></span> <span class="shuliang">×<span><!--@php  echo $item['total'];@--></span></span>
                        <div class="delete"><a href="javascript:;" onclick="removeCart(<!--@php  echo $item['id'];@-->)"><img src="__RESOURCE__/recouse/images/delete.png"></a></div>
                    </div>

                </div>
            </div>
        </div>
        <!--@php } @-->
        </form>

    </div>

    <div class="cart_foot">
        <div class="goods_total">已选商品<span id="choose_num"><!--@php echo count($list); @--></span>件</div>
        <div class="goods_money">
            <table style="text-align:right;border:none;width:100%;">
                <tr>
                    <td >金额(不含运费,税费)：</td>
                    <td style="padding-left:15px;color:#D22147;">¥<span id="huodong_zonge"><!--@php  echo number_format($price,2,'.','');@--></span></td>
                </tr>
               <!-- <tr style="color:#B2B2B2;">
                    <td>优惠商额：</td>
                    <td style="padding-left:15px;">-¥<span id="youhui_zonge">00.00</span></td>
                </tr>-->

            </table>
            <div class="jiesuan">
                <button type="button" class="btn btn-danger btn-sm"  id="jiesuan" onclick="checkcredit()" >&nbsp;&nbsp;&nbsp;结&nbsp;&nbsp;算&nbsp;&nbsp;&nbsp;</button>
            </div>
        </div>
    </div>
</div>
<!--@php } @-->
</div>



<!--@php include themePage('footer');@-->

<script type="text/javascript">
    $(function(){
        $("#choose_all").click();
        choose_or_not_choose();

        $(".goodsnum").blur(function(){
            var id = $(this).attr("cartid");
            if($(this).isInt()){
                var init_num = $("#item_" +id).find(".shuliang span").html();
                var num = parseInt( $("#goodsnum_" + id).val() );
                var maxbuy = parseInt( $(this).attr("maxbuy") );
                var kucun = parseInt($("#hide_kucun_" +id).val());
                if(num < 1){
                    //返回初始个数
                    $("#goodsnum_" + id).val(init_num);
                    tip("对不起，输入有误",1);
                    return;
                }
                if(num>kucun){
                    $("#goodsnum_" + id).val(init_num);
                    tip("对不起，库存不足",1);
                    return;
                }
                if(num > maxbuy && maxbuy>0){
                    $("#goodsnum_" + id).val(init_num);
                    tip("最多只能购买"+maxbuy+"件",1);
                    return;
                }

                $("#item_" +id).find(".shuliang span").html('1');
                updateCart(id,num);
                canculate();
            }
            else{
                $(this).val("1");
                $("#item_" +id).find(".shuliang span").html('1');
                updateCart(id,1);
				canculate();
            }
            
        })
        
    })
function clearCart(){
    if (confirm('确定要清空购物车吗？')) {
        tip("正在处理数据...");
        $.getJSON("<!--@php  echo mobile_url('mycart',array('op'=>'clear'));@-->", function(s){
            $(".shopcart-item").remove();
            $("#cartempty").show();
            $(".shopcart-item").hide();
            $(".cart_foot").hide();
            tip_close();
        });
    }
}
function removeCart(id){
    if (confirm('您确定要删除此商品吗？')) {
        tip("正在处理数据...");
        var url  = "<!--@php  echo mobile_url('mycart', array('op'=>'remove'))@-->" + "&id=" + id;
        $.getJSON(url, function(s){
            $("#item_" + s.cartid).remove();
            if($(".cart_list").length<=0){
                $("#cartempty").show();
                $(".shopcart-item").hide();
                $(".cart_foot").hide();
            }
            tip_close();
            canculate();
        });
    }
}

$("#delbat_btn").click(function(){
    var isnum = 0;
    var idarr = [];
    $(".cart_list").each(function(){
        if($(this).find('.child_checkbox').is(':checked')){
            isnum ++;
            idarr.push($(this).find('.child_checkbox').val());
        }
    })
    
    if(isnum != 0){
        if(confirm("你确定要删除么？")){
            var ids = {ids:idarr};
            var url = "<!--@php echo mobile_url('mycart',array('op'=>'delbat')); @-->";
            tip('正在处理中！');
            $.post(url,ids,function(data){
                tip(data.message,1);
                if(data.errno == 200){
                    for(var i=0;i<idarr.length;i++){
                        var id = idarr[i];
                        $("#item_" + id).remove();
                    }
                     if($(".cart_list").length<=0){
                        $("#cartempty").show();
                        $(".shopcart-item").hide();
                        $(".cart_foot").hide();
                        $("#choose_all").prop("checked",false);
                    }
                    choose_or_not_choose();
                }

            },'json')
        }

    }else{
        tip('对不起你还没有选择！',1);
    }


})

function updateCart(id,num){
    
      var url  = "<!--@php  echo mobile_url('mycart', array('op'=>'update'))@-->" + "&id=" + id+"&num=" + num;
      $.getJSON(url, function(s){
      });
}

function addNum(id,maxbuy){
    var num = parseInt( $("#goodsnum_" + id).val() );
    var kucun = parseInt($("#hide_kucun_" +id).val());
    num++;
    if(num>kucun){
        tip("对不起，库存不足",1);
        return;
    }
    if(num > maxbuy && maxbuy>0){
        tip("最多只能购买"+maxbuy+"件",1);
        return;
    }
    $("#goodsnum_" + id).val(num);
    $("#item_" +id).find(".shuliang span").html(num);
    canculate();
    updateCart(id,num);
}
function checkcredit(){
    var ok = false;
    $(".child_checkbox").each(function(){
        if(this.checked){
            ok = true;
        }
    })
    if(ok){
        $("form[name='cartform']").submit();
    }else{
        tip('你还没有选择商品！',1);
    }

}
function reduceNum(id){
    var num = parseInt( $("#goodsnum_" + id).val() );
    if(num-1<=0){
        return;
    }
    num--;
    $("#goodsnum_" + id).val(num);
    $("#item_" +id).find(".shuliang span").html(num);
    canculate();
    updateCart(id,num);
}
function canculate(){
    var total = 0;
    var num = 0;
    $(".child_checkbox").each(function(){
       if($(this).is(":checked")){
           num += 1;
           var price = $(this).closest('.cart_list').find(".singletotalprice").html();
           var geshu = $(this).closest('.cart_list').find(".shuliang span").html();
           total += parseFloat(price) * geshu;
       }
    });

    total = parseFloat(total).toFixed(2);
    $("#huodong_zonge").html(total);
    $("#pricetotal").html(total);
    $("#cart_title_num").html(num);
    $("#choose_num").html(num);
    if(num == 0){
        //全选去掉
        $("#choose_all").prop("checked",false);
        $("#jiesuan").attr("disabled",true);
    }else{
        $("#choose_all").prop("checked",true);
        $("#jiesuan").attr("disabled",false);
    }
}

function choose_or_not_choose(){
    var isChooseAll = $("#choose_all").is(":checked");
    $(".child_checkbox").each(function(){
        if(isChooseAll){
            $(this).prop("checked",true);
        }else{
            $(this).prop("checked",false);
        }
    })
    canculate();
    if(isChooseAll){
        $("#jiesuan").attr("disabled",false);
    }else{
        $("#jiesuan").attr("disabled",true);
    }
}

$(".child_checkbox").click(function(){
    canculate();
})
$(".return").click(function(){
    window.history.back(-1);
})
</script>
<script language='javascript'>
function tip(msg,autoClose){
     var div = $("#poptip");
     var content =$("#poptip_content");
     if(div.length<=0){
         div = $("<div id='poptip'></div>").appendTo(document.body);
         content =$("<div id='poptip_content'>" + msg + "</div>").appendTo(document.body);
     }
     else{
         content.html(msg);
         content.show(); div.show();
     }
     if(autoClose) {
        setTimeout(function(){
            content.fadeOut(500);
            div.fadeOut(500);

        },1000);
     }
}
function tip_close(){
    $("#poptip").fadeOut(500);
     $("#poptip_content").fadeOut(500);
}
</script>
<script>
	jQuery(document).ready(function($) {
		$("img.lazy").lazyload({
			placeholder : "__RESOURCE__/recouse/images/ajax-loader.gif", // 占位图
			threshold : 200, //控制灵敏度
			effect : "fadeIn"
		});
		
	});
</script>
 <script type="text/javascript"	src="__RESOURCE__/recouse/js/jquery.lazyload.min.js"></script>
<script src="__RESOURCE__/recouse/js/zepto.min.js" type="text/javascript"></script>
</body>
</html>